<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamentos - Centro Automotivo JJ</title>
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/modal-fix.css">
  <link rel="stylesheet" href="/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="/css/main-styles.css"> 
  <link rel="stylesheet" href="/css/agendamentos.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/style1.css">
  <style>
    /* Correção para padronizar a capitalização dos badges */
    .status-badge {
      text-transform: capitalize;
    }
    
    /* ===== ESTILOS DEFINITIVOS PARA BOTÕES - PRIORIDADE MÁXIMA ===== */
    
    /* Botões de adicionar cliente/veículo - quadrados com cantos arredondados */
    .form-group .d-flex .btn-outline-primary,
    #agendamento-form .btn-outline-primary,
    button.btn-outline-primary[data-bs-toggle="modal"] {
      width: 36px !important;
      height: 36px !important;
      min-width: 36px !important;
      max-width: 36px !important;
      padding: 0 !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      border-radius: 8px !important; /* Quadrado com cantos arredondados */
      flex-shrink: 0 !important;
      font-size: 0.85rem !important;
      border: 2px solid var(--cor-primaria) !important; /* Borda amarela padrão */
      color: black !important; /* Ícone amarelo padrão */
      background-color: var(--cor-primaria) !important; /* Fundo levemente amarelo */
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08) !important;
      margin-top: 2px !important;
      outline: none !important;
    }
    
    .form-group .d-flex .btn-outline-primary:hover {
      background-color: var(--cor-primaria) !important; /* Fundo amarelo padrão sólido */
      color: var(--cor-secundaria) !important; /* Ícone preto */
      transform: translateY(-2px) scale(1.05) !important;
      box-shadow: 0 6px 12px rgba(255, 215, 0, 0.4) !important;
      border-color: var(--cor-primaria-hover) !important;
    }
    
    .form-group .d-flex .btn-outline-primary:active {
      transform: translateY(0) scale(0.98) !important;
      box-shadow: 0 2px 4px rgba(255, 215, 0, 0.2) !important;
    }
    
    .form-group .d-flex .btn-outline-primary:disabled {
      opacity: 0.4 !important;
      cursor: not-allowed !important;
      transform: none !important;
      box-shadow: none !important;
      border-color: #cccccc !important;
      color: #cccccc !important;
      background-color: transparent !important;
    }
    
    .form-group .d-flex .btn-outline-primary i {
      margin: 0 !important;
      font-size: 0.8rem !important;
      font-weight: 600 !important;
    }
    
    /* RESPONSIVIDADE DEFINITIVA */
    @media (max-width: 768px) {
      /* Força layout em coluna no mobile */
      .form-row {
        display: flex !important;
        flex-direction: column !important;
        margin: 0 !important;
      }
      
      .form-col {
        width: 100% !important;
        padding: 0 !important;
        margin-bottom: 15px !important;
      }
      
      .form-group {
        margin-bottom: 15px !important;
      }
      
      .form-container {
        padding: 20px 15px !important;
        margin: 0 !important;
      }

      /* Botão QR Code abaixo apenas no mobile */
      #agendamento-form .d-flex.gap-2 {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 0 !important;
      }
      
      #agendamento-form .d-flex.gap-2 > .input-wrapper.flex-grow-1 {
        width: 100% !important;
        flex: none !important;
      }
      
      #agendamento-form .d-flex.gap-2 > button#btn-abrir-qrcode,
      #agendamento-form .d-flex.gap-2 > .btn-outline-dark {
        width: 100% !important;
        margin-top: 10px !important;
        padding: 12px !important;
        border-radius: 8px !important;
      }
      
      /* Botões de + maiores no mobile */
      .form-group .d-flex .btn-outline-primary,
      #agendamento-form .btn-outline-primary,
      button.btn-outline-primary[data-bs-toggle="modal"] {
        width: 40px !important;
        height: 40px !important;
        min-width: 40px !important;
        max-width: 40px !important;
        border-radius: 8px !important;
        font-size: 0.9rem !important;
      }
      
      .form-group .d-flex .btn-outline-primary i {
        font-size: 0.85rem !important;
      }
    }
  </style>

  <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
  <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/js/sweetalert2.all.min.js"></script>
  <script src="/js/validacao.js"></script>
  <script src="/js/qrcode.min.js"></script>
</head>

<body>
  <div th:replace="~{barra :: barra}"></div>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h2><i class="fas fa-calendar-check"></i> Gerenciamento de Agendamentos</h2>
        <p>Visualize e gerencie os agendamentos de serviços</p>
      </div>

      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <h3 th:text="${agendaPendente}"></h3>
            <p>Agendamentos pendentes</p>
          </div>
        </div>

        <div class="stat-card warning">
          <div class="stat-icon">
            <i class="fas fa-cog"></i>
          </div>
          <div class="stat-info">
            <h3 th:text="${agendaAndamento}"></h3>
            <p>Em andamento</p>
          </div>
        </div>

        <div class="stat-card success">
          <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-info">
            <h3 th:text="${agendaConcluidoHoje}"></h3>
            <p>Concluídos hoje</p>
          </div>
        </div>
      </div>
	  
      <!-- Formulário de Agendamento -->
      <div class="form-container" id="agendamento-form-container" style="display: none;">
        <h3 id="formTitulo"><i class="fas fa-plus-circle"></i> Novo Agendamento</h3>

        <form method="post" action="/agendamento-api/salvar" id="agendamento-form" enctype="multipart/form-data">
		  <input type="hidden" id="idCliente" name="idCliente">
		  <input type="hidden" id="idVeiculo" name="idVeiculo">
		  <input type="hidden" name="tokenMobile" id="tokenMobile">
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="nome_cliente">Nome do Cliente</label>
                <div class="d-flex">
                  <div class="input-wrapper flex-grow-1">
                    <i class="fas fa-user input-icon"></i>
                    <input type="text" id="nome-cliente" name="nomeCliente" list="lista-clientes" placeholder="Nome completo do cliente" required>
                    <datalist id="lista-clientes"></datalist>
                  </div>
                  <button type="button" class="btn btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#cadastrarClienteModal" title="Cadastrar Novo Cliente">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="form-col">
              <div class="form-group">
                <label for="veiculo">Veículo</label>
                <div class="d-flex">
                  <div class="input-wrapper flex-grow-1">
                    <i class="fas fa-car input-icon"></i>
                    <input type="text" id="veiculo" name="veiculoNome" list="lista-veiculos" placeholder="Modelo/Placa do veículo" disabled>
                    <datalist id="lista-veiculos"></datalist>
                  </div>
                  <button type="button" id="add-veiculo" class="btn btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#cadastrarVeiculoModal" title="Cadastrar Novo Veículo" disabled>
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="form-col">
              <div class="form-group">
                <label for="tipo_servico">Tipo de Serviço</label>
                <div class="input-wrapper">
                  <i class="fas fa-tools input-icon"></i>
                  <select id="nome-servico" name="idServico" required>
                    <option value="">Selecione um serviço</option>
                    <option th:each="serv : ${servicos}" th:value="${serv.idServico}" th:text="${serv.nomeServico}">
                    </option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="data-previsao">Agendamento para</label>
                <div class="input-wrapper">
                  <i class="fas fa-calendar-alt input-icon"></i>
                  <input type="date" id="data-previsao" name="dataPrevisao">
                </div>
              </div>
            </div>

            <div class="form-col" style="display: none" id="data_conclusao_container">
              <div class="form-group">
                <label for="data-conclusao">Data de Conclusão</label>
                <div class="input-wrapper">
                  <i class="fas fa-calendar-plus input-icon"></i>
                  <input type="date" id="data-conclusao" name="dataConclusao">
                </div>
              </div>
            </div>
          </div>


          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="status">Status</label>
                <div class="input-wrapper">
                  <i class="fas fa-info-circle input-icon"></i>
                  <select id="status" name="statusAgendamento" required>
                    <option value="Agendado">Agendado</option>
                    <option value="Confirmado">Confirmado</option>
                    <option value="Em Andamento">Em Andamento</option>
                    <option value="Concluido">Concluído</option>
                    <option value="Cancelado">Cancelado</option>
                  </select>
                </div>
              </div>
            </div>


          </div>

          <div class="form-group">
            <label for="observacao">Observações</label>
            <div class="input-wrapper">
              <i class="fas fa-comment-alt input-icon"></i>
              <textarea id="observacao" name="observacao" rows="3" maxlength="200"
                placeholder="Observações adicionais sobre o agendamento"></textarea>
            </div>
            <div id="observacao-counter" class="text-end text-muted" style="font-size: 0.85em; margin-top: 5px;">
              <small>0/200</small>
            </div>
          </div>

          <div class="form-group mt-3">
            <label for="agendamento-imagens"><i class="fas fa-camera"></i> Imagens do Serviço</label>
			
			<div class="d-flex gap-2">
	            <div class="input-wrapper flex-grow-1">
	                <input type="file" id="agendamento-imagens" name="imagens" multiple accept="image/*" class="form-control" style="padding-left: 10px;">				
	            </div>			
				<button type="button" class="btn btn-outline-dark text-nowrap" id="btn-abrir-qrcode" title="Usar Câmera do Celular">
	                <i class="fas fa-qrcode"></i> Enviar pelo Celular
	            </button>
			</div>
            <div id="form-preview-imagens" class="d-flex flex-wrap gap-2 mt-2">
                <!-- Preview das imagens aqui -->
            </div>
			
			<div id="aviso-token-mobile" class="alert alert-info mt-2 p-2 align-items-center justify-content-between" style="display: none;">
			    <div>
			        <small><i class="fas fa-mobile-alt"></i> Sessão mobile ativa. Fotos do celular serão vinculadas ao salvar.</small>
			    </div>
			    <button type="button" id="btn-cancelar-mobile" class="btn btn-sm btn-outline-danger ms-2" style="padding: 0 8px; font-size: 0.75rem; line-height: 1.5;">
			        <i class="fas fa-times"></i> Cancelar
			    </button>
			</div>
          </div>

          <div class="form-actions">
            <input type="hidden" name="idAgendamento" id="idAgendamento" readonly>
            <button type="reset" class="btn btn-secondary" id="btn-cancelar-novo-agendamento">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="submit" class="btn" id="salvarAg">
              <i class="fas fa-save"></i> Salvar Agendamento
            </button>
          </div>
        </form>
        <form id="deleteForm" action="/agendamento-api/apagar" method="post" style="display: none;">
          <input type="hidden" name="idAgendamento" id="deleteId">
        </form>
      </div>

      <!-- Tabela de Agendamentos -->
      <div class="table-container" id="lista-agendamentos-container">
        <div class="table-header">
          <h3><i class="fas fa-list"></i> Lista de Agendamentos</h3>
          <button class="btn btn-primary" id="btn-novo-agendamento">
            <i class="fas fa-plus"></i> Novo Agendamento
          </button>
        </div>

        <div class="table-filters">
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="busca">Buscar Agendamento</label>
                <div class="input-wrapper">
                  <!-- <i class="fas fa-search input-icon"></i> -->
                  <input type="text" id="busca" name="busca" placeholder="Digite para buscar...">
                </div>
              </div>
            </div>

            <div class="form-col">
              <div class="form-group">
                <label for="filtro_status">Filtrar por Status</label>
                <div class="input-wrapper">
                  <i class="fas fa-filter input-icon"></i>
                  <select id="filtro_status" name="filtro_status">
                    <option value="">Todos os status</option>
                    <option value="Agendado">Agendado</option>
                    <option value="Confirmado">Confirmado</option>
                    <option value="Em Andamento">Em Andamento</option>
                    <option value="Concluido">Concluído</option>
                    <option value="Cancelado">Cancelado</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="appointments-table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Tipo de Serviço</th>
                <th>Previsão</th>
                <th>Conclusão</th>
                <th>Status</th>
                <th>Observação</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr th:if="${agendamentos == null or agendamentos.empty}">
                <td colspan="8" style="text-align: center;">Nenhum resultado encontrado</td>
              </tr>
              <tr th:each="ag : ${agendamentos}">
                <td data-label="Cliente" class="ag-cliente">
					<span th:text="${ag.cliente.nomeCliente}"></span>
				</td>
                <td data-label="Tipo de Serviço" class="ag-servico" th:attr="data-servico-id=${ag.servico.idServico}">
                  <span class="service-badge" th:if="${ag.servico != null && ag.servico.nomeServico != null}"
                    th:classappend="' ' + ${#strings.replace(ag.servico.nomeServico.toLowerCase(), ' ', '-')}"
                    th:text="${ag.servico.nomeServico}"> </span>
                  <span th:if="${ag.servico == null or ag.servico.nomeServico == null}"></span>
                </td>
                <td data-label="Previsão" class="ag-previsao" th:text="${#temporals.format(ag.dataPrevisao, 'dd/MM/yyyy')}"
                  th:data-date="${#temporals.format(ag.dataPrevisao, 'yyyy-MM-dd')}">
                </td>
                <td data-label="Conclusão" class="ag-conclusao">
                  <span th:if="${ag.dataConclusao != null}" th:text="${#temporals.format(ag.dataConclusao, 'dd/MM/yyyy')}" th:data-date="${#temporals.format(ag.dataConclusao, 'yyyy-MM-dd')}"></span>
                  <span th:unless="${ag.dataConclusao != null}">-</span>
                </td>
                <td data-label="Status" class="ag-status">
                  <span class="status-badge"
                    th:classappend="' ' + ${#strings.replace(ag.statusAgendamento.toLowerCase(), ' ', '_')}"
                    th:text="${#strings.replace(ag.statusAgendamento, '_', ' ')}"></span>
                </td>
                <td data-label="Observação" th:text="${ag.observacao}" class="observacao-cell ag-observacao"></td>
				
                <td class="action-buttons">
                  <button class="btn-icon btn-edit" th:attr="data-id=${ag.idAgendamento}, data-veiculo-id=${ag.veiculo.idVeiculo},
					               data-veiculo-nome=${ag.veiculo.modelo + ' - ' + ag.veiculo.placa}" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button th:if="${usuarioLogado != null and usuarioLogado.acesso == 'admin'}"
				  class="btn-icon btn-delete" th:attr="data-id=${ag.idAgendamento}" title="Excluir">
                    <i class="fas fa-trash"></i>
                  </button>
                  <button class="btn-icon btn-view" th:attr="data-id=${ag.idAgendamento},
												  data-veiculo-info=${ag.veiculo.marca + ' - ' + ag.veiculo.modelo},
												  data-cliente-email=${ag.cliente.email},
												  data-cliente-telefone=${ag.cliente.telefone}" title="Visualizar">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button th:if="${!#strings.equalsIgnoreCase(ag.statusAgendamento, 'Concluido') and !#strings.equalsIgnoreCase(ag.statusAgendamento, 'Concluído') and !#strings.equalsIgnoreCase(ag.statusAgendamento, 'Cancelado')}"
                          class="btn-icon btn-concluir" th:attr="data-id=${ag.idAgendamento}" title="Concluir">
                    <i class="fas fa-check"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="table-pagination">
          <button class="btn btn-secondary" id="btn-anterior" disabled>
            <i class="fas fa-chevron-left"></i> Anterior
          </button>
          <span class="pagination-info">Página 1 de 1</span>
          <button class="btn btn-secondary" id="btn-proximo" disabled>
            Próximo <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>


    </div>

	<!-- QR CODE -->
	<div class="modal fade" id="modalQrCode" tabindex="-1" aria-labelledby="modalQrCodeLabel" aria-hidden="true">
	    <div class="modal-dialog modal-dialog-centered">
	      <div class="modal-content">
	        <div class="modal-header">
	          <h5 class="modal-title" id="modalQrCodeLabel"><i class="fas fa-mobile-alt"></i> Enviar fotos pelo celular</h5>
	          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	        </div>
	        <div class="modal-body text-center">
	          <p class="text-muted">Escaneie o código abaixo com a câmera do seu celular para anexar fotos.</p>
	          
	          <div id="qrcode-container" class="d-flex justify-content-center my-3"></div>
	          
	          <div class="alert alert-warning small">
	            <i class="fas fa-exclamation-triangle"></i> Mantenha essa tela aberta no PC enquanto envia as fotos pelo celular.
	            <br>Depois, clique em <strong>Fechar</strong> e salve o agendamento.
	          </div>
	        </div>
	        <div class="modal-footer">
	          <button type="button" id="btn-fechar-qrcode" class="btn btn-secondary" data-bs-dismiss="modal">Fechar e Voltar</button>
	        </div>
	      </div>
	    </div>
	  </div>
	
    <!-- Modal de Visualização -->
    <div class="bootstrap-iso">
      <div class="modal fade" id="visualizarAgendamentoModal" tabindex="-1"
        aria-labelledby="visualizarAgendamentoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="visualizarAgendamentoModalLabel">
                <i class="fas fa-eye"></i> Detalhes do Agendamento
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-8">
                  <h4><strong id="modal-cliente-agendamento"></strong></h4>
				  
				  <div class="mb-2 text-muted small">
			        <span class="me-3"><i class="fas fa-phone-alt me-1"></i><span id="modal-cliente-telefone"></span></span>
			        <span><i class="fas fa-envelope me-1"></i><span id="modal-cliente-email"></span></span>
			      </div>
				  
                  <p class="text-muted">Tipo de Serviço: <span id="modal-servico-agendamento"></span></p>
				  <p class="text-muted mb-0" style="font-size: 0.95rem;">
	                  <i class="fas fa-car me-2"></i>Veículo: <span id="modal-veiculo-agendamento" class="text-dark fw-bold"></span>
	                </p>
                </div>
				<div class="col-md-4 text-md-end">
                  <h5 id="titulo-data-modal">Previsão</h5>
				  <h4 class="text-success fw-bold" id="modal-previsao-agendamento"></h4>
                </div>
				<div class="mt-3">
				    <h6><i class="fas fa-camera me-2"></i>Fotos do Serviço</h6>
				    <div class="gallery-carousel-wrapper">
				        <button type="button" class="gallery-nav gallery-prev" id="btn-galeria-prev">
				            <i class="fas fa-chevron-left"></i>
				        </button>
				        <div id="galeria-visualizacao" class="gallery-track"></div>
				        <button type="button" class="gallery-nav gallery-next" id="btn-galeria-next">
				            <i class="fas fa-chevron-right"></i>
				        </button>
				    </div>
				</div>
              </div>
              <hr>
              <h6><i class="fas fa-align-left me-2"></i>Observações</h6>
              <p id="modal-observacao" style="white-space: pre-wrap;"></p>
              <hr>
			  <div class="d-flex align-items-center">
  				<p class="mb-0" style="font-size: 1.1rem;"><strong>Status: </strong><span id="modal-status"></span></p>
  			 </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times"></i> Fechar
              </button>
            </div>
          </div>
        </div>
      </div>
		
      <!-- Modal Cadastrar Cliente -->
      <div class="modal fade" id="cadastrarClienteModal" tabindex="-1" aria-labelledby="cadastrarClienteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cadastrarClienteModalLabel"><i class="fas fa-user-plus"></i> Novo Cliente</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="form-novo-cliente">
                <div class="mb-3">
                  <label for="novo-cliente-nome" class="form-label">Nome Completo</label>
                  <input type="text" class="form-control" id="novo-cliente-nome" maxlength="80" required>
				  <div id="erro-nome-cli" class="invalid-feedback">Digite nome e sobrenome.</div>
                </div>
                <div class="mb-3">
                  <label for="novo-cliente-telefone" class="form-label">Telefone/Celular</label>
                  <input type="tel" class="form-control" id="novo-cliente-telefone" maxlength="15" required>
				  <div class="invalid-feedback">Telefone incompleto (mínimo 10 dígitos + DDD).</div>
                </div>
                <div class="mb-3">
                  <label for="novo-cliente-email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="novo-cliente-email" placeholder="nome@exemplo.com">
				  <div class="invalid-feedback">E-mail inválido.</div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" id="btn-salvar-novo-cliente">Salvar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Cadastrar Veículo -->
      <div class="modal fade" id="cadastrarVeiculoModal" tabindex="-1" aria-labelledby="cadastrarVeiculoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cadastrarVeiculoModalLabel"><i class="fas fa-car"></i> Novo Veículo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="form-novo-veiculo">
				<input type="hidden" id="idCliente">
                <div class="mb-3">
                  <label for="novo-veiculo-modelo" class="form-label">Modelo</label>
                  <input type="text" class="form-control" id="novo-veiculo-modelo" placeholder="Ex: Gol, Civic..." maxlength="35" required>
                </div>
                <div class="mb-3">
                  <label for="novo-veiculo-placa" class="form-label">Placa</label>
                  <input type="text" class="form-control" id="novo-veiculo-placa" placeholder="ABC-1234" maxlength="7" required>
				  <div class="invalid-feedback">Placa obrigatória (7 caracteres).</div>
                </div>
                <div class="mb-3">
                  <label for="novo-veiculo-marca" class="form-label">Marca</label>
                  <input type="text" class="form-control" id="novo-veiculo-marca" placeholder="Ex: VW, Honda..." maxlength="20">
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" id="btn-salvar-novo-veiculo">Salvar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Anexar Imagens -->
      <div class="modal fade" id="anexarImagensModal" tabindex="-1" aria-labelledby="anexarImagensModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="anexarImagensModalLabel"><i class="fas fa-images"></i> Anexar Imagens</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="form-anexar-imagens">
                <input type="hidden" id="id-agendamento-imagens">
                <div class="mb-3">
                  <label for="input-imagens" class="form-label">Selecione as imagens</label>
                  <input class="form-control" type="file" id="input-imagens" multiple accept="image/*">
                </div>
                <div id="preview-imagens" class="d-flex flex-wrap gap-2 mt-3 justify-content-center">
                    <!-- Preview das imagens aqui -->
                    <p class="text-muted w-100 text-center">Nenhuma imagem selecionada</p>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" id="btn-salvar-imagens">Salvar Anexos</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Rodapé -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo">
          <i class="fas fa-car-alt"></i>
          <span class="logo-highlight">Centro Automotivo </span> JJ
        </div>
        <p class="footer-copyright">&copy; 2025 Centro Automotivo JJ. Todos os direitos reservados.</p>
      </div>
    </div>
  </footer>

  <script th:inline="javascript">
      document.addEventListener('DOMContentLoaded', function () {
          // ============================================================
          // 1. DADOS E VARIÁVEIS GLOBAIS
          // ============================================================
          const todosClientes = /*[[${clientes}]]*/ []; 
          const todosVeiculos = /*[[${veiculos}]]*/ []; 

          const formContainer = document.getElementById('agendamento-form-container');
          const formAgendamento = document.getElementById('agendamento-form');
          const btnNovoAgendamento = document.getElementById('btn-novo-agendamento');
          const btnCancelar = document.getElementById('btn-cancelar-novo-agendamento');
          
          const inputNome = document.getElementById('nome-cliente');
          const inputId = document.getElementById('idCliente');
          const datalistCli = document.getElementById('lista-clientes');
          const inputVeiculo = document.getElementById('veiculo');
          const inputIdVeiculo = document.getElementById('idVeiculo');
          const datalistVeic = document.getElementById('lista-veiculos');
          const btnAddVeiculo = document.getElementById('add-veiculo');

          const btnQrCode = document.getElementById('btn-abrir-qrcode');
          const inputToken = document.getElementById('tokenMobile');
          const avisoMobile = document.getElementById('aviso-token-mobile');
          const btnCancelarMobile = document.getElementById('btn-cancelar-mobile');
          const qrcodeContainer = document.getElementById('qrcode-container');
          const modalQrCodeEl = document.getElementById('modalQrCode');
          const modalQrCode = modalQrCodeEl ? new bootstrap.Modal(modalQrCodeEl) : null;

          // ============================
          // LÓGICA DE CLIENTE E VEÍCULO 
          // ============================

          // Função para Habilitar/Desabilitar campos de veículo
          function toggleCamposVeiculo(habilitar) {
              if (inputVeiculo && btnAddVeiculo) {
                  inputVeiculo.disabled = !habilitar;
                  btnAddVeiculo.disabled = !habilitar;
                  
                  if (habilitar) {
                      inputVeiculo.placeholder = "Modelo/Placa do veículo";
                  } else {
                      inputVeiculo.value = "";
                      if(inputIdVeiculo) inputIdVeiculo.value = "";
                      inputVeiculo.placeholder = "Selecione o cliente primeiro...";
                      inputVeiculo.classList.remove('is-valid');
                      if(datalistVeic) datalistVeic.innerHTML = "";
                  }
              }
          }

          // Estado Inicial: Bloqueia se não tiver cliente selecionado
          if (!inputId || !inputId.value) {
              toggleCamposVeiculo(false);
          }

          // Preenche Datalist de Clientes
          if (todosClientes && datalistCli) {
              todosClientes.forEach(c => {
                  const opt = document.createElement('option');
                  opt.value = c.nomeCliente;
                  datalistCli.appendChild(opt);
              });
          }

          // Evento: Digitar Cliente
          if (inputNome) {
              inputNome.addEventListener('input', function() {
                  const valor = this.value.trim();
                  
                  if (valor === "") {
                      inputId.value = "";
                      this.classList.remove('is-valid');
                      toggleCamposVeiculo(false);
                      return;
                  }

                  // Busca cliente
                  const cliente = todosClientes.find(c => c.nomeCliente === valor);

                  if (cliente) {
                      inputId.value = cliente.idCliente;
                      this.classList.add('is-valid');
                      this.classList.remove('is-invalid');
                      
                      toggleCamposVeiculo(true);
                      filtrarVeiculos(cliente.idCliente);
                  } else {
                      inputId.value = "";
                      this.classList.remove('is-valid');
                      toggleCamposVeiculo(false);
                  }
              });
          }

          // Função: Filtrar Veículos por Cliente
          function filtrarVeiculos(idCliente) {
              if(!todosVeiculos || !datalistVeic) return;
              
              datalistVeic.innerHTML = "";
              inputVeiculo.value = "";
              if(inputIdVeiculo) inputIdVeiculo.value = "";
              
              const filtrados = todosVeiculos.filter(v => v.cliente && v.cliente.idCliente === idCliente);
              
              filtrados.forEach(v => {
                  const opt = document.createElement('option');
                  opt.value = v.modelo + " - " + v.placa;
                  datalistVeic.appendChild(opt);
              });
              
              // Regra: Se só tem 1, seleciona automático
              if (filtrados.length === 1) {
                  const v = filtrados[0];
                  inputVeiculo.value = v.modelo + " - " + v.placa;
                  if(inputIdVeiculo) inputIdVeiculo.value = v.idVeiculo;
                  inputVeiculo.classList.add('is-valid');
              }
          }

          // Evento: Selecionar Veículo Manualmente (quando tem 2+)
          if (inputVeiculo) {
              inputVeiculo.addEventListener('input', function() {
                  const valor = this.value;
                  const idCli = parseInt(inputId.value);
                  const veiculo = todosVeiculos.find(v => 
                      (v.modelo + " - " + v.placa) === valor && 
                      (v.cliente && v.cliente.idCliente === idCli)
                  );
                  
                  if (veiculo) {
                      if(inputIdVeiculo) inputIdVeiculo.value = veiculo.idVeiculo;
                      this.classList.add('is-valid');
                  } else {
                      if(inputIdVeiculo) inputIdVeiculo.value = "";
                      this.classList.remove('is-valid');
                  }
              });
          }

          // =================================================
          // CONTROLE DO FORMULÁRIO (NOVO / CANCELAR / EDITAR)
          // =================================================
          if (btnNovoAgendamento) {
              btnNovoAgendamento.addEventListener('click', function () {
				  dt = new DataTransfer();
				  idsFotosRenderizadas.clear();
				  prevDiv.innerHTML = "";
				  
                  document.getElementById('idAgendamento').value = "";
                  document.getElementById('formTitulo').innerHTML = '<i class="fas fa-plus"></i> Novo Agendamento';
                  
                  if(inputNome) { inputNome.value = ""; inputNome.classList.remove('is-valid'); }
                  if(inputId) inputId.value = "";
                  
                  toggleCamposVeiculo(false);
                  
                  if(inputToken) inputToken.value = "";
                  if(avisoMobile) { avisoMobile.classList.remove('d-flex'); avisoMobile.style.display = 'none'; }
                  
                  document.getElementById('form-preview-imagens').innerHTML = "";
                  if(formAgendamento) formAgendamento.reset();

                  if(formContainer) {
                      formContainer.style.display = 'block';
                      formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  }
              });
          }

          if (btnCancelar) {
              btnCancelar.addEventListener('click', function () {
                  if(formContainer) formContainer.style.display = 'none';
                  if(formAgendamento) formAgendamento.reset();
                  document.getElementById('lista-agendamentos-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
              });
          }

          // Editar
		  document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', function () {
                const row = this.closest('tr');
                const id = this.dataset.id;
                const veiculoId = this.getAttribute('data-veiculo-id');
                const veiculoNome = this.getAttribute('data-veiculo-nome');
                
                document.getElementById('formTitulo').innerHTML = '<i class="fas fa-edit"></i> Editar Agendamento';
                document.getElementById('idAgendamento').value = id;
                
                dt = new DataTransfer();
                if(inpImg) inpImg.files = dt.files;
                prevDiv.innerHTML = "";
                
                if(inputNome) inputNome.value = row.querySelector('.ag-cliente span').textContent.trim();
                const nomeNaTabela = inputNome.value;
                const cliObj = todosClientes.find(c => c.nomeCliente === nomeNaTabela);
                if(cliObj) {
                    inputId.value = cliObj.idCliente;
                    toggleCamposVeiculo(true);
                }
                
                if (veiculoId && veiculoNome) {
                    document.getElementById('veiculo').value = veiculoNome;
                    document.getElementById('idVeiculo').value = veiculoId;
                } else {
                    document.getElementById('veiculo').value = "";
                    document.getElementById('idVeiculo').value = "";
                }

                document.getElementById('nome-servico').value = row.querySelector('.ag-servico').dataset.servicoId;
                const statusTxt = row.querySelector('.ag-status span').textContent.trim();
                const statusSel = document.getElementById('status');
                for(let i=0; i<statusSel.options.length; i++) {
                    if(statusSel.options[i].text.replace(/\s/g, '') === statusTxt.replace(/\s/g, '')) {
                        statusSel.selectedIndex = i; break;
                    }
                }
                checkStatus();

                const prev = row.querySelector('.ag-previsao');
                if(prev) document.getElementById('data-previsao').value = prev.dataset.date;
                const conc = row.querySelector('.ag-conclusao');
                if(conc) document.getElementById('data-conclusao').value = conc.dataset.date || '';
                
                document.getElementById('observacao').value = row.querySelector('.ag-observacao').textContent.trim();

                // Carrega Imagens Existentes no Banco
				fetch(`/fotos-api/listar/${id}`)
	              .then(r => r.status === 204 ? [] : r.json())
	              .then(fotos => {
	                  if(fotos && fotos.length > 0) {
	                      fotos.forEach(foto => {
	                          const div = document.createElement('div');
	                          div.className = 'preview-wrapper db-photo'; 
	                          
	                          div.style.borderColor = '#0d6efd'; 
	
	                          const img = document.createElement('img');
	                          img.src = `/fotos-api/imagem/${foto.id}`;
	                          img.className = 'preview-img';
	                          
	                          const btnDel = document.createElement('div');
	                          btnDel.className = 'btn-delete-img';
	                          btnDel.innerHTML = '<i class="fas fa-trash-alt"></i>'; 
	                          btnDel.title = 'Excluir foto permanentemente';
	
	                          btnDel.onclick = function() {
	                              Swal.fire({
	                                  title: 'Excluir imagem?',
	                                  text: "Essa foto será apagada permanentemente.",
	                                  icon: 'warning',
	                                  showCancelButton: true,
	                                  confirmButtonColor: '#d33',
	                                  confirmButtonText: 'Sim, apagar!'
	                              }).then((result) => {
	                                  if (result.isConfirmed) {
	                                      fetch(`/fotos-api/apagar/${foto.id}`, { method: 'DELETE' })
	                                      .then(response => {
	                                          if(response.ok) {
	                                              div.remove(); 
	                                              Swal.fire('Apagado!', 'Imagem removida.', 'success');
	                                          } else {
	                                              Swal.fire('Erro', 'Erro ao apagar.', 'error');
	                                          }
	                                      });
	                                  }
	                              });
	                          };
	
	                          div.appendChild(img);
	                          div.appendChild(btnDel);
	                          prevDiv.appendChild(div);
	                      });
	                  }
	              })
	              .catch(err => console.error("Erro ao carregar fotos:", err));
                formContainer.style.display = 'block';
                formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        });

		  
	  // ============================================================
      // LÓGICA MOBILE (BUSCA AO FECHAR O MODAL)
      // ============================================================
      let idsFotosRenderizadas = new Set(); 
      const btnFecharQr = document.getElementById('btn-fechar-qrcode');

      if(btnQrCode) {
          btnQrCode.addEventListener('click', function() {
              if(!inputToken.value) {
                  inputToken.value = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                  );
                  if(avisoMobile) {
                      avisoMobile.style.display = 'flex';
                      avisoMobile.classList.add('d-flex');
                  }
              }

              // Gera QR Code
              const token = inputToken.value;
              const url = `http://192.168.23.107:8080/mobile/upload-fotos/${token}`; // Ajuste seu IP se mudar
              
              if(qrcodeContainer) {
                  qrcodeContainer.innerHTML = "";
                  new QRCode(qrcodeContainer, { text: url, width: 200, height: 200 });
              }
              if(modalQrCode) modalQrCode.show();
          });
      }

      if(btnFecharQr) {
          btnFecharQr.addEventListener('click', function() {
              const token = inputToken.value;
              if(!token) return;

              fetch(`/fotos-api/listar-temp/${token}`)
                  .then(r => r.json())
                  .then(fotos => {
                      if(fotos && fotos.length > 0) {
                          fotos.forEach(foto => {
                              if(!idsFotosRenderizadas.has(foto.id)) {
                                  renderizarFotoMobile(foto);
                                  idsFotosRenderizadas.add(foto.id);
                              }
                          });
                          Swal.fire({
                              title: 'Fotos Recebidas!',
                              text: `${fotos.length} imagens foram identificadas.`,
                              icon: 'success',
                              timer: 2000,
                              showConfirmButton: false
                          });
                      }
                  })
                  .catch(e => console.error("Erro ao buscar fotos mobile:", e));
		      });
		  }

		function renderizarFotoMobile(foto) {
        const div = document.createElement('div');
        // Adicionamos a classe 'mobile-photo' para rastrear
        div.className = 'preview-wrapper db-photo mobile-photo'; 
        div.style.borderColor = '#198754';

        const img = document.createElement('img');
        img.src = `/fotos-api/imagem/${foto.id}`;
        img.className = 'preview-img';
        
        const btnDel = document.createElement('div');
        btnDel.className = 'btn-delete-img';
        btnDel.innerHTML = '<i class="fas fa-trash-alt"></i>';
        btnDel.title = 'Apagar foto';

        btnDel.onclick = function() {
             // Chama a API para apagar do banco/disco
             fetch(`/fotos-api/apagar/${foto.id}`, { method: 'DELETE' })
             .then(r => {
                 if(r.ok) {
                     // 1. Remove visualmente
                     div.remove();
                     idsFotosRenderizadas.delete(foto.id);

                     // 2. NOVA LÓGICA: Verifica se ainda existem fotos mobile na tela
                     const fotosRestantes = document.querySelectorAll('.mobile-photo').length;
                     
                     if (fotosRestantes === 0) {
                         // Se não sobrou nenhuma, mata a sessão mobile do formulário
                         const inputToken = document.getElementById('tokenMobile');
                         const aviso = document.getElementById('aviso-token-mobile');
                         
                         if(inputToken) inputToken.value = "";
                         
                         if(aviso) {
                             aviso.classList.remove('d-flex');
                             aviso.style.display = 'none';
                         }
                         
                         // Opcional: Feedback visual discreto
                         const Toast = Swal.mixin({
                            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                         });
                         Toast.fire({ icon: 'info', title: 'Sessão mobile finalizada (sem fotos)' });
                     }
                 }
             });
        };

        const iconMobile = document.createElement('div');
        iconMobile.innerHTML = '<i class="fas fa-mobile-alt"></i>';
        iconMobile.style.cssText = "position: absolute; bottom: -5px; right: -5px; background: #198754; color: white; border-radius: 50%; padding: 2px 5px; font-size: 10px;";

        div.appendChild(img);
        div.appendChild(btnDel);
        div.appendChild(iconMobile);          
        prevDiv.appendChild(div);
    }

          // Preview de Imagens Desktop
		  const inpImg = document.getElementById('agendamento-imagens');
		  const prevDiv = document.getElementById('form-preview-imagens');
		  let dt = new DataTransfer(); 

		  if(inpImg && prevDiv) {
  		      inpImg.addEventListener('change', function() {
  		          for(let file of this.files){
  		              dt.items.add(file);
  		          }
  		          this.files = dt.files;
                  const fotosDoBanco = Array.from(prevDiv.querySelectorAll('.db-photo'));
  		          prevDiv.innerHTML = "";

                  fotosDoBanco.forEach(div => prevDiv.appendChild(div));

  		          Array.from(dt.files).forEach((file, index) => {
  		              if(file.type.startsWith('image/')) {
  		                  const reader = new FileReader();
  		                  reader.onload = e => {
  		                      const div = document.createElement('div');
  		                      div.className = 'preview-wrapper';

  		                      const img = document.createElement('img');
  		                      img.src = e.target.result;
  		                      img.className = 'preview-img';
  		                      
  		                      const btn = document.createElement('div');
  		                      btn.className = 'btn-delete-img';
  		                      btn.innerHTML = 'X';
  		                      btn.title = 'Remover envio';

  		                      btn.onclick = () => {
  		                          const novoDt = new DataTransfer();
  		                          Array.from(dt.files).forEach((f, i) => {
  		                              if(i !== index) novoDt.items.add(f);
  		                          });
  		                          
  		                          dt = novoDt;
  		                          inpImg.files = dt.files;
  		                          div.remove(); 
  		                      };

  		                      div.appendChild(img);
  		                      div.appendChild(btn);
  		                      prevDiv.appendChild(div);
  		                  };
  		                  reader.readAsDataURL(file);
  		              }
  		          });
  		      });
  		  }

		  // ============================================================
          // VISUALIZAR IMAGENS (CARROSSEL + DATAS + DADOS CLIENTE)
          // ============================================================
          const modalVisEl = document.getElementById('visualizarAgendamentoModal');
          
          if (modalVisEl) {
              const modalVis = new bootstrap.Modal(modalVisEl);
              const track = document.getElementById('galeria-visualizacao');
              const btnPrev = document.getElementById('btn-galeria-prev');
              const btnNext = document.getElementById('btn-galeria-next');
              const scrollAmount = 300; 
			  
              function atualizarBotoes() {
                  if(!track) return;
                  const precisaRolagem = track.scrollWidth > track.clientWidth;
                  if (!precisaRolagem) {
                      btnPrev.classList.remove('visible');
                      btnNext.classList.remove('visible');
                      return;
                  }

                  if (track.scrollLeft > 5) btnPrev.classList.add('visible');
                  else btnPrev.classList.remove('visible');

                  if (Math.ceil(track.scrollLeft + track.clientWidth) >= track.scrollWidth - 5) {
                      btnNext.classList.remove('visible');
                  } else {
                      btnNext.classList.add('visible');
                  }
              }

              if(btnPrev && btnNext && track) {
                  btnPrev.addEventListener('click', () => {
                      track.scrollLeft -= scrollAmount;
                      setTimeout(atualizarBotoes, 350); 
                  });
                  btnNext.addEventListener('click', () => {
                      track.scrollLeft += scrollAmount;
                      setTimeout(atualizarBotoes, 350);
                  });
                  track.addEventListener('scroll', atualizarBotoes);
              }
              
              modalVisEl.addEventListener('shown.bs.modal', atualizarBotoes);

              // ==========================================
              // EVENTO DE CLIQUE NO BOTÃO "VISUALIZAR"
              // ==========================================
              document.querySelectorAll('.btn-view').forEach(btn => {
                  btn.addEventListener('click', function () {
                      const row = this.closest('tr');
                      const idAgendamento = this.dataset.id;
                      const infoVeiculo = this.getAttribute('data-veiculo-info') || '-';
                      const email = this.getAttribute('data-cliente-email') || '-';
                      const telefone = this.getAttribute('data-cliente-telefone') || '-';

                      const statusTexto = row.querySelector('.ag-status span').textContent.trim();
                      const dataPrevisao = row.querySelector('.ag-previsao').textContent.trim();
                      const dataConclusao = row.querySelector('.ag-conclusao').textContent.trim();

                      document.getElementById('modal-cliente-agendamento').textContent = row.querySelector('.ag-cliente').textContent.trim();
                      document.getElementById('modal-cliente-email').textContent = email;
                      document.getElementById('modal-cliente-telefone').textContent = telefone;
                      document.getElementById('modal-servico-agendamento').textContent = row.querySelector('.ag-servico').textContent.trim();
                      document.getElementById('modal-veiculo-agendamento').textContent = infoVeiculo;
                      document.getElementById('modal-observacao').textContent = row.querySelector('.ag-observacao').textContent.trim();
                      document.getElementById('modal-status').textContent = statusTexto;

                      const tituloData = document.getElementById('titulo-data-modal');
                      const valorData = document.getElementById('modal-previsao-agendamento');
                      const statusNormalizado = statusTexto.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

                      if (statusNormalizado === 'concluido' && dataConclusao !== '-' && dataConclusao !== '') {
                          tituloData.textContent = 'Conclusão';
                          valorData.textContent = dataConclusao;
                      } else {
                          tituloData.textContent = 'Previsão';
                          valorData.textContent = dataPrevisao;
                      }

                      track.innerHTML = '<p class="text-muted small w-100 text-center py-4">Carregando...</p>';
                      btnPrev.classList.remove('visible');
                      btnNext.classList.remove('visible');
                      track.scrollLeft = 0;

                      fetch(`/fotos-api/listar/${idAgendamento}`)
                      .then(r => r.status === 204 ? [] : r.json())
                      .then(fotos => {
                          track.innerHTML = "";
                          
                          if(!fotos || fotos.length === 0) {
                              track.innerHTML = '<p class="text-muted small w-100 text-center py-4">Nenhuma foto anexada.</p>';
                              atualizarBotoes();
                              return;
                          }

                          fotos.forEach(f => {
                              const div = document.createElement('div');
                              div.className = 'gallery-item';
                              
                              const img = document.createElement('img');
                              img.src = `/fotos-api/imagem/${f.id}`;
                              img.alt = "Foto";
                              img.title = "Clique para ampliar";
                              
                              img.onload = () => atualizarBotoes();
                              div.onclick = () => window.open(img.src, '_blank');
                              
                              div.appendChild(img);
                              track.appendChild(div);
                          });

                          atualizarBotoes(); 
                          setTimeout(atualizarBotoes, 500);
                      })
                      .catch(e => {
                          console.error(e);
                          track.innerHTML = '<p class="text-danger small w-100 text-center">Erro ao carregar imagens.</p>';
                      });
                      modalVis.show();
                  });
              });
          }
          // ============================================================
          // UTILITÁRIOS (Status, Filtros, Delete, Modais Rápidos)
          // ============================================================

          // Status -> Data Conclusão
          const statusSel = document.getElementById('status');
          const divConc = document.getElementById('data_conclusao_container');
          const inpConc = document.getElementById('data-conclusao');
          function checkStatus() {
              if(statusSel && statusSel.value === 'Concluido') {
                  divConc.style.display = 'block';
                  inpConc.required = true;
                  if(!inpConc.value) inpConc.value = new Date().toISOString().split('T')[0];
              } else {
                  if(divConc) divConc.style.display = 'none';
                  if(inpConc) { inpConc.required = false; inpConc.value = ""; }
              }
          }
          if(statusSel) statusSel.addEventListener('change', checkStatus);
          checkStatus();

          // Excluir
          document.querySelectorAll('.btn-delete').forEach(btn => {
              btn.addEventListener('click', function (e) {
                  e.preventDefault();
                  const id = this.dataset.id;
                  Swal.fire({
                      title: 'Excluir?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Sim'
                  }).then(r => {
                      if(r.isConfirmed) {
                          document.getElementById('deleteId').value = id;
                          document.getElementById('deleteForm').submit();
                      }
                  });
              });
          });

          // Concluir Rápido
          document.querySelectorAll('.btn-concluir').forEach(btn => {
              btn.addEventListener('click', function () {
                  const id = this.dataset.id;
                  Swal.fire({ title: 'Concluir Serviço?', icon: 'question', showCancelButton: true }).then(r => {
                      if(r.isConfirmed) {
                          fetch(`/agendamento-api/concluir/${id}`, { method: 'POST' })
                          .then(res => res.ok ? res.json() : Promise.reject())
                          .then(() => Swal.fire('Sucesso', '', 'success').then(() => location.reload()))
                          .catch(() => Swal.fire('Erro', '', 'error'));
                      }
                  });
              });
          });

          // Filtros da Tabela
          const busca = document.getElementById('busca');
          const filtroSt = document.getElementById('filtro_status');
          function filtrar() {
              const t = busca.value.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              const s = filtroSt.value.toLowerCase();
              document.querySelectorAll('tbody tr').forEach(row => {
                  const txt = row.textContent.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                  const badge = row.querySelector('.status-badge');
                  const stText = badge ? badge.textContent.toLowerCase().replace(/\s/g, '') : '';
                  
                  const okBusca = !t || txt.includes(t);
                  const okStatus = !s || stText.includes(s.replace(/\s/g, ''));
                  row.style.display = (okBusca && okStatus) ? '' : 'none';
              });
          }
          if(busca) busca.addEventListener('input', filtrar);
          if(filtroSt) filtroSt.addEventListener('change', filtrar);

          // Menu
          const ham = document.getElementById('hamburger-menu');
          const nav = document.getElementById('nav-menu');
          if(ham && nav) ham.addEventListener('click', () => { nav.classList.toggle('active'); ham.classList.toggle('active'); });

		// ============================================================
        // CADASTRO RÁPIDO CLIENTE
        // ============================================================
        const btnSalvarCli = document.getElementById('btn-salvar-novo-cliente');
        const inpNomeCli = document.getElementById('novo-cliente-nome');
        const inpTelCli = document.getElementById('novo-cliente-telefone');
        const inpEmailCli = document.getElementById('novo-cliente-email');

		if (btnSalvarCli && inpNomeCli && inpTelCli) {
            btnSalvarCli.disabled = true;

            function isNomeCliValido() {
                const valor = inpNomeCli.value.trim();
                const partes = valor.split(' ').filter(p => p.length > 0);
                return partes.length >= 2;
            }

            function isTelCliValido() { 
                const raw = inpTelCli.value.replace(/\D/g, "");
                return raw.length === 10 || raw.length === 11;
            }

            function isEmailCliValido() {
                const valor = inpEmailCli.value.trim();
                if (valor === "") return true; 
                return /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(valor);
            }

            function monitorarModalCliente() {
                const nomeOk = isNomeCliValido();
                const telOk = isTelCliValido();
                const emailOk = isEmailCliValido();
                
                btnSalvarCli.disabled = !(nomeOk && telOk && emailOk);
            }

            inpNomeCli.addEventListener('input', () => {
                inpNomeCli.classList.remove('is-invalid');
                monitorarModalCliente();
            });
            inpNomeCli.addEventListener('blur', () => {
                if(!isNomeCliValido()) inpNomeCli.classList.add('is-invalid');
                monitorarModalCliente();
            });

            inpTelCli.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, "");
                
                if (v.length > 11) v = v.substring(0, 11);
                v = v.replace(/^(\d\d)(\d)/g, "($1) $2");
				                
                if (v.replace(/\D/g, "").length === 11) {
                    v = v.replace(/(\d{5})(\d{4})$/, "$1-$2");
                } else {
                    v = v.replace(/(\d{4})(\d{0,4})$/, "$1-$2");
                }
                
                e.target.value = v;
                inpTelCli.classList.remove('is-invalid');
                monitorarModalCliente();
            });

            inpTelCli.addEventListener('blur', () => {
                if(!isTelCliValido()) inpTelCli.classList.add('is-invalid');
                monitorarModalCliente();
            });

            if(inpEmailCli) {
                inpEmailCli.addEventListener('input', function() {
                    if(this.value.includes(' ')) this.value = this.value.replace(/\s/g, '');
                    this.classList.remove('is-invalid');
                    monitorarModalCliente();
                });
                inpEmailCli.addEventListener('blur', function() {
                    if(this.value.trim() !== "" && !isEmailCliValido()) {
                        this.classList.add('is-invalid');
                    }
                    monitorarModalCliente();
                });
            }
			
            btnSalvarCli.addEventListener('click', function() {
                const nome = inpNomeCli.value.trim();
                const tel = inpTelCli.value.trim();
                const email = inpEmailCli.value.trim();

                fetch('/cliente-api/salvar', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({nomeCliente: nome, telefone: tel, email: email})
                }).then(r => r.ok ? r.json() : Promise.reject())
                .then(cli => {
                    todosClientes.push(cli);
                    
                    const inputNomePrincipal = document.getElementById('nome-cliente');
                    const inputIdPrincipal = document.getElementById('idCliente');
                    const datalistCli = document.getElementById('lista-clientes');
                    
                    if(inputNomePrincipal) {
                        inputNomePrincipal.value = cli.nomeCliente;
                        inputNomePrincipal.classList.add('is-valid');
                        inputNomePrincipal.classList.remove('is-invalid');
                    }
                    if(inputIdPrincipal) inputIdPrincipal.value = cli.idCliente;
                    
                    if(datalistCli) {
                        const opt = document.createElement('option'); opt.value = cli.nomeCliente;
                        datalistCli.appendChild(opt);
                    }
                    
                    toggleCamposVeiculo(true);
                    
                    bootstrap.Modal.getInstance(document.getElementById('cadastrarClienteModal')).hide();
                    document.getElementById('form-novo-cliente').reset();
                    btnSalvarCli.disabled = true;
                    [inpNomeCli, inpTelCli, inpEmailCli].forEach(el => el.classList.remove('is-invalid'));

                    Swal.fire('Sucesso', 'Cliente cadastrado', 'success');
                }).catch(() => Swal.fire('Erro', 'Falha ao salvar cliente', 'error'));
            });
        }

	  // ============================================================
      // CADASTRO RÁPIDO VEÍCULO
      // ============================================================
      const btnSalvarVeic = document.getElementById('btn-salvar-novo-veiculo');
      const inpModVeic = document.getElementById('novo-veiculo-modelo');
      const inpPlaVeic = document.getElementById('novo-veiculo-placa');
      const inpMarVeic = document.getElementById('novo-veiculo-marca');

      if (btnSalvarVeic && inpModVeic && inpPlaVeic) {
          btnSalvarVeic.disabled = true;

          function isModeloValido() { return inpModVeic.value.trim().length > 0; }
          function isPlacaValida() { return inpPlaVeic.value.trim().length === 7; }

          function monitorarModalVeiculo() {
              const modOk = isModeloValido();
              const plaOk = isPlacaValida();
              btnSalvarVeic.disabled = !(modOk && plaOk);
          }

          inpModVeic.addEventListener('input', () => {
              inpModVeic.classList.remove('is-invalid');
              monitorarModalVeiculo();
          });
          inpModVeic.addEventListener('blur', () => {
              if(!isModeloValido()) inpModVeic.classList.add('is-invalid');
              monitorarModalVeiculo();
          });

          inpPlaVeic.addEventListener('input', function() {
              let v = this.value.toUpperCase().replace(/\s/g, '');
              v = v.replace(/[^A-Z0-9]/g, '');
              this.value = v;
              this.classList.remove('is-invalid');
              monitorarModalVeiculo();
          });
          
          inpPlaVeic.addEventListener('blur', () => {
              if(!isPlacaValida()) inpPlaVeic.classList.add('is-invalid');
              monitorarModalVeiculo();
          });

          btnSalvarVeic.addEventListener('click', function() {
              const idCli = document.getElementById('idCliente').value;
              const mod = inpModVeic.value.trim();
              const pla = inpPlaVeic.value.trim();
              const mar = inpMarVeic.value.trim();
              
              if(!idCli) {
                  Swal.fire('Atenção', 'Selecione um cliente no formulário principal antes de cadastrar o veículo.', 'warning');
                  bootstrap.Modal.getInstance(document.getElementById('cadastrarVeiculoModal')).hide();
                  return;
              }

              fetch('/veiculo-api/salvar', {
                  method: 'POST', headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({
                      cliente: {idCliente: idCli},
                      modelo: mod,
                      placa: pla,
                      marca: mar
                  })
              }).then(r => r.ok ? r.json() : Promise.reject())
              .then(v => {
                  todosVeiculos.push(v);
                  
                  const inputVeiculo = document.getElementById('veiculo');
                  const inputIdVeiculo = document.getElementById('idVeiculo');
                  const datalistVeic = document.getElementById('lista-veiculos');

                  if(inputVeiculo) {
                      inputVeiculo.value = v.modelo + " - " + v.placa;
                      inputVeiculo.classList.add('is-valid');
                      inputVeiculo.setAttribute('list', 'lista-veiculos');
                  }
                  if(inputIdVeiculo) inputIdVeiculo.value = v.idVeiculo;
                  if(datalistVeic) {
                      const opt = document.createElement('option');
                      opt.value = v.modelo + " - " + v.placa;
                      datalistVeic.appendChild(opt);
                  }
                  
                  bootstrap.Modal.getInstance(document.getElementById('cadastrarVeiculoModal')).hide();
                  document.getElementById('form-novo-veiculo').reset();
                  
                  [inpModVeic, inpPlaVeic].forEach(el => el.classList.remove('is-invalid'));
                  btnSalvarVeic.disabled = true;

                  Swal.fire('Sucesso', 'Veículo salvo', 'success');
              }).catch(() => Swal.fire('Erro', 'Falha ao salvar veículo', 'error'));
          });
      }
      });
    </script>
    <script src="/js/script.js"></script>
</body>
</html>