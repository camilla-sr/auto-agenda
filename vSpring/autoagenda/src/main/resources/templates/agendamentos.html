<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamentos - Centro Automotivo JJ</title>
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/modal-fix.css">
  <link rel="stylesheet" href="/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="/css/main-styles.css"> 
  <link rel="stylesheet" href="/css/agendamentos.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/style1.css">
  <style>
    /* Correção para padronizar a capitalização dos badges */
    .status-badge {
      text-transform: capitalize;
    }
  </style>

  <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
  <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/js/sweetalert2.all.min.js"></script>
  <script src="/js/validacao.js"></script>
  <script src="/js/qrcode.min.js"></script>
</head>

<body>
  <div th:replace="~{barra :: barra}"></div>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h2><i class="fas fa-calendar-check"></i> Gerenciamento de Agendamentos</h2>
        <p>Visualize e gerencie os agendamentos de serviços</p>
      </div>

      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <h3 th:text="${agendaPendente}"></h3>
            <p>Agendamentos pendentes</p>
          </div>
        </div>

        <div class="stat-card warning">
          <div class="stat-icon">
            <i class="fas fa-cog"></i>
          </div>
          <div class="stat-info">
            <h3 th:text="${agendaAndamento}"></h3>
            <p>Em andamento</p>
          </div>
        </div>

        <div class="stat-card success">
          <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-info">
            <h3 th:text="${agendaConcluidoHoje}"></h3>
            <p>Concluídos hoje</p>
          </div>
        </div>
      </div>
	  
      <!-- Formulário de Agendamento -->
      <div class="form-container" id="agendamento-form-container" style="display: none;">
        <h3 id="formTitulo"><i class="fas fa-plus-circle"></i> Novo Agendamento</h3>

        <form method="post" action="/agendamento-api/salvar" id="agendamento-form" enctype="multipart/form-data">
		  <input type="hidden" id="idCliente" name="idCliente">
		  <input type="hidden" id="idVeiculo" name="idVeiculo">
		  <input type="hidden" name="tokenMobile" id="tokenMobile">
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="nome_cliente">Nome do Cliente</label>
                <div class="d-flex">
                  <div class="input-wrapper flex-grow-1">
                    <i class="fas fa-user input-icon"></i>
                    <input type="text" id="nome-cliente" name="nomeCliente" list="lista-clientes" placeholder="Nome completo do cliente" required>
                    <datalist id="lista-clientes"></datalist>
                  </div>
                  <button type="button" class="btn btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#cadastrarClienteModal" title="Cadastrar Novo Cliente">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="form-col">
              <div class="form-group">
                <label for="veiculo">Veículo</label>
                <div class="d-flex">
                  <div class="input-wrapper flex-grow-1">
                    <i class="fas fa-car input-icon"></i>
                    <input type="text" id="veiculo" name="veiculoNome" list="lista-veiculos" placeholder="Modelo/Placa do veículo" disabled>
                    <datalist id="lista-veiculos"></datalist>
                  </div>
                  <button type="button" id="add-veiculo" class="btn btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#cadastrarVeiculoModal" title="Cadastrar Novo Veículo" disabled>
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="form-col">
              <div class="form-group">
                <label for="tipo_servico">Tipo de Serviço</label>
                <div class="input-wrapper">
                  <i class="fas fa-tools input-icon"></i>
                  <select id="nome-servico" name="idServico" required>
                    <option value="">Selecione um serviço</option>
                    <option th:each="serv : ${servicos}" th:value="${serv.idServico}" th:text="${serv.nomeServico}">
                    </option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="data-previsao">Agendamento para</label>
                <div class="input-wrapper">
                  <i class="fas fa-calendar-alt input-icon"></i>
                  <input type="date" id="data-previsao" name="dataPrevisao">
                </div>
              </div>
            </div>

            <div class="form-col" style="display: none" id="data_conclusao_container">
              <div class="form-group">
                <label for="data-conclusao">Data de Conclusão</label>
                <div class="input-wrapper">
                  <i class="fas fa-calendar-plus input-icon"></i>
                  <input type="date" id="data-conclusao" name="dataConclusao">
                </div>
              </div>
            </div>
          </div>


          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="status">Status</label>
                <div class="input-wrapper">
                  <i class="fas fa-info-circle input-icon"></i>
                  <select id="status" name="statusAgendamento" required>
                    <option value="Agendado">Agendado</option>
                    <option value="Confirmado">Confirmado</option>
                    <option value="Em Andamento">Em Andamento</option>
                    <option value="Concluido">Concluído</option>
                    <option value="Cancelado">Cancelado</option>
                  </select>
                </div>
              </div>
            </div>


          </div>

          <div class="form-group">
            <label for="observacao">Observações</label>
            <div class="input-wrapper">
              <i class="fas fa-comment-alt input-icon"></i>
              <textarea id="observacao" name="observacao" rows="3" maxlength="200"
                placeholder="Observações adicionais sobre o agendamento"></textarea>
            </div>
            <div id="observacao-counter" class="text-end text-muted" style="font-size: 0.85em; margin-top: 5px;">
              <small>0/200</small>
            </div>
          </div>

          <div class="form-group mt-3">
            <label for="agendamento-imagens"><i class="fas fa-camera"></i> Imagens do Serviço</label>
			
			<div class="d-flex gap-2">
	            <div class="input-wrapper flex-grow-1">
	                <input type="file" id="agendamento-imagens" name="imagens" multiple accept="image/*" class="form-control" style="padding-left: 10px;">				
	            </div>			
				<button type="button" class="btn btn-outline-dark text-nowrap" id="btn-abrir-qrcode" title="Usar Câmera do Celular">
	                <i class="fas fa-qrcode"></i> Enviar pelo Celular
	            </button>
			</div>
            <div id="form-preview-imagens" class="d-flex flex-wrap gap-2 mt-2">
                <!-- Preview das imagens aqui -->
            </div>
			
			<div id="aviso-token-mobile" class="alert alert-info mt-2 p-2 align-items-center justify-content-between" style="display: none;">
			    <div>
			        <small><i class="fas fa-mobile-alt"></i> Sessão mobile ativa. Fotos do celular serão vinculadas ao salvar.</small>
			    </div>
			    <button type="button" id="btn-cancelar-mobile" class="btn btn-sm btn-outline-danger ms-2" style="padding: 0 8px; font-size: 0.75rem; line-height: 1.5;">
			        <i class="fas fa-times"></i> Cancelar
			    </button>
			</div>
          </div>

          <div class="form-actions">
            <input type="hidden" name="idAgendamento" id="idAgendamento" readonly>
            <button type="reset" class="btn btn-secondary" id="btn-cancelar-novo-agendamento">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="submit" class="btn" id="salvarAg">
              <i class="fas fa-save"></i> Salvar Agendamento
            </button>
          </div>
        </form>
        <form id="deleteForm" action="/agendamento-api/apagar" method="post" style="display: none;">
          <input type="hidden" name="idAgendamento" id="deleteId">
        </form>
      </div>

      <!-- Tabela de Agendamentos -->
      <div class="table-container" id="lista-agendamentos-container">
        <div class="table-header">
          <h3><i class="fas fa-list"></i> Lista de Agendamentos</h3>
          <button class="btn btn-primary" id="btn-novo-agendamento">
            <i class="fas fa-plus"></i> Novo Agendamento
          </button>
        </div>

        <div class="table-filters">
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="busca">Buscar Agendamento</label>
                <div class="input-wrapper">
                  <!-- <i class="fas fa-search input-icon"></i> -->
                  <input type="text" id="busca" name="busca" placeholder="Digite para buscar...">
                </div>
              </div>
            </div>

            <div class="form-col">
              <div class="form-group">
                <label for="filtro_status">Filtrar por Status</label>
                <div class="input-wrapper">
                  <i class="fas fa-filter input-icon"></i>
                  <select id="filtro_status" name="filtro_status">
                    <option value="">Todos os status</option>
                    <option value="Agendado">Agendado</option>
                    <option value="Confirmado">Confirmado</option>
                    <option value="Em Andamento">Em Andamento</option>
                    <option value="Concluido">Concluído</option>
                    <option value="Cancelado">Cancelado</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="appointments-table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Tipo de Serviço</th>
                <th>Previsão</th>
                <th>Conclusão</th>
                <th>Status</th>
                <th>Observação</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr th:if="${agendamentos == null or agendamentos.empty}">
                <td colspan="8" style="text-align: center;">Nenhum resultado encontrado</td>
              </tr>
              <tr th:each="ag : ${agendamentos}">
                <td data-label="Cliente" class="ag-cliente">
					<span th:text="${ag.cliente.nomeCliente}"></span>
				</td>
                <td data-label="Tipo de Serviço" class="ag-servico" th:attr="data-servico-id=${ag.servico.idServico}">
                  <span class="service-badge" th:if="${ag.servico != null && ag.servico.nomeServico != null}"
                    th:classappend="' ' + ${#strings.replace(ag.servico.nomeServico.toLowerCase(), ' ', '-')}"
                    th:text="${ag.servico.nomeServico}"> </span>
                  <span th:if="${ag.servico == null or ag.servico.nomeServico == null}"></span>
                </td>
                <td data-label="Previsão" class="ag-previsao" th:text="${#temporals.format(ag.dataPrevisao, 'dd/MM/yyyy')}"
                  th:data-date="${#temporals.format(ag.dataPrevisao, 'yyyy-MM-dd')}">
                </td>
                <td data-label="Conclusão" class="ag-conclusao">
                  <span th:if="${ag.dataConclusao != null}" th:text="${#temporals.format(ag.dataConclusao, 'dd/MM/yyyy')}" th:data-date="${#temporals.format(ag.dataConclusao, 'yyyy-MM-dd')}"></span>
                  <span th:unless="${ag.dataConclusao != null}">-</span>
                </td>
                <td data-label="Status" class="ag-status">
                  <span class="status-badge"
                    th:classappend="' ' + ${#strings.replace(ag.statusAgendamento.toLowerCase(), ' ', '_')}"
                    th:text="${#strings.replace(ag.statusAgendamento, '_', ' ')}"></span>
                </td>
                <td data-label="Observação" th:text="${ag.observacao}" class="observacao-cell ag-observacao"></td>
				
                <td class="action-buttons">
                  <button class="btn-icon btn-edit" th:attr="data-id=${ag.idAgendamento}, data-veiculo-id=${ag.veiculo.idVeiculo},
					               data-veiculo-nome=${ag.veiculo.modelo + ' - ' + ag.veiculo.placa}" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button th:if="${usuarioLogado != null and usuarioLogado.acesso == 'admin'}"
				  class="btn-icon btn-delete" th:attr="data-id=${ag.idAgendamento}" title="Excluir">
                    <i class="fas fa-trash"></i>
                  </button>
                  <button class="btn-icon btn-view" th:attr="data-id=${ag.idAgendamento}" title="Visualizar">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button th:if="${!#strings.equalsIgnoreCase(ag.statusAgendamento, 'Concluido') and !#strings.equalsIgnoreCase(ag.statusAgendamento, 'Concluído') and !#strings.equalsIgnoreCase(ag.statusAgendamento, 'Cancelado')}"
                          class="btn-icon btn-concluir" th:attr="data-id=${ag.idAgendamento}" title="Concluir">
                    <i class="fas fa-check"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="table-pagination">
          <button class="btn btn-secondary" id="btn-anterior" disabled>
            <i class="fas fa-chevron-left"></i> Anterior
          </button>
          <span class="pagination-info">Página 1 de 1</span>
          <button class="btn btn-secondary" id="btn-proximo" disabled>
            Próximo <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>


    </div>

	<!-- QR CODE -->
	<div class="modal fade" id="modalQrCode" tabindex="-1" aria-labelledby="modalQrCodeLabel" aria-hidden="true">
	    <div class="modal-dialog modal-dialog-centered">
	      <div class="modal-content">
	        <div class="modal-header">
	          <h5 class="modal-title" id="modalQrCodeLabel"><i class="fas fa-mobile-alt"></i> Enviar fotos pelo celular</h5>
	          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	        </div>
	        <div class="modal-body text-center">
	          <p class="text-muted">Escaneie o código abaixo com a câmera do seu celular para anexar fotos.</p>
	          
	          <div id="qrcode-container" class="d-flex justify-content-center my-3"></div>
	          
	          <div class="alert alert-warning small">
	            <i class="fas fa-exclamation-triangle"></i> Mantenha essa tela aberta no PC enquanto envia as fotos pelo celular.
	            <br>Depois, clique em <strong>Fechar</strong> e salve o agendamento.
	          </div>
	        </div>
	        <div class="modal-footer">
	          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar e Voltar</button>
	        </div>
	      </div>
	    </div>
	  </div>
	
    <!-- Modal de Visualização (sem alterações) -->
    <div class="bootstrap-iso">
      <div class="modal fade" id="visualizarAgendamentoModal" tabindex="-1"
        aria-labelledby="visualizarAgendamentoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="visualizarAgendamentoModalLabel">
                <i class="fas fa-eye"></i> Detalhes do Agendamento
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-8">
                  <h4><strong id="modal-cliente-agendamento"></strong></h4>
                  <p class="text-muted">Tipo de Serviço: <span id="modal-servico-agendamento"></span></p>
                </div>
                <div class="col-md-4 text-md-end">
                  <h5>Previsão</h5>
                  <h4 class="text-success fw-bold" id="modal-previsao-agendamento"></h4>
                </div>
				<div id="galeria-visualizacao" class="d-flex flex-wrap gap-2 mt-3 justify-content-end"></div>
              </div>
              <hr>
              <h6><i class="fas fa-align-left me-2"></i>Observações</h6>
              <p id="modal-observacao" style="white-space: pre-wrap;"></p>
              <hr>
              <div class="row">
                <div class="col-sm-6">
                  <p><strong>Status:</strong> <span id="modal-status"></span></p>
                  <p><strong>Conclusão:</strong> <span id="modal-conclusao"></span></p>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times"></i> Fechar
              </button>
            </div>
          </div>
        </div>
      </div>
		
      <!-- Modal Cadastrar Cliente -->
      <div class="modal fade" id="cadastrarClienteModal" tabindex="-1" aria-labelledby="cadastrarClienteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cadastrarClienteModalLabel"><i class="fas fa-user-plus"></i> Novo Cliente</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="form-novo-cliente">
                <div class="mb-3">
                  <label for="novo-cliente-nome" class="form-label">Nome Completo</label>
                  <input type="text" class="form-control" id="novo-cliente-nome" required>
                </div>
                <div class="mb-3">
                  <label for="novo-cliente-telefone" class="form-label">Telefone/Celular</label>
                  <input type="tel" class="form-control" id="novo-cliente-telefone" required>
                </div>
                <div class="mb-3">
                  <label for="novo-cliente-email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="novo-cliente-email" placeholder="nome@exemplo.com">
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" id="btn-salvar-novo-cliente">Salvar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Cadastrar Veículo -->
      <div class="modal fade" id="cadastrarVeiculoModal" tabindex="-1" aria-labelledby="cadastrarVeiculoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cadastrarVeiculoModalLabel"><i class="fas fa-car"></i> Novo Veículo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="form-novo-veiculo">
				<input type="hidden" id="idCliente">
                <div class="mb-3">
                  <label for="novo-veiculo-modelo" class="form-label">Modelo</label>
                  <input type="text" class="form-control" id="novo-veiculo-modelo" placeholder="Ex: Gol, Civic..." required>
                </div>
                <div class="mb-3">
                  <label for="novo-veiculo-placa" class="form-label">Placa</label>
                  <input type="text" class="form-control" id="novo-veiculo-placa" placeholder="ABC-1234" required>
                </div>
                <div class="mb-3">
                  <label for="novo-veiculo-marca" class="form-label">Marca</label>
                  <input type="text" class="form-control" id="novo-veiculo-marca" placeholder="Ex: VW, Honda...">
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" id="btn-salvar-novo-veiculo">Salvar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Anexar Imagens -->
      <div class="modal fade" id="anexarImagensModal" tabindex="-1" aria-labelledby="anexarImagensModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="anexarImagensModalLabel"><i class="fas fa-images"></i> Anexar Imagens</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="form-anexar-imagens">
                <input type="hidden" id="id-agendamento-imagens">
                <div class="mb-3">
                  <label for="input-imagens" class="form-label">Selecione as imagens</label>
                  <input class="form-control" type="file" id="input-imagens" multiple accept="image/*">
                </div>
                <div id="preview-imagens" class="d-flex flex-wrap gap-2 mt-3 justify-content-center">
                    <!-- Preview das imagens aqui -->
                    <p class="text-muted w-100 text-center">Nenhuma imagem selecionada</p>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" id="btn-salvar-imagens">Salvar Anexos</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Rodapé -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo">
          <i class="fas fa-car-alt"></i>
          <span class="logo-highlight">Centro Automotivo </span> JJ
        </div>
        <p class="footer-copyright">&copy; 2025 Centro Automotivo JJ. Todos os direitos reservados.</p>
      </div>
    </div>
  </footer>

  <script th:inline="javascript">
      document.addEventListener('DOMContentLoaded', function () {
          // ============================================================
          // 1. DADOS E VARIÁVEIS GLOBAIS
          // ============================================================
          
          // Dados vindos do Java (Thymeleaf)
          const todosClientes = /*[[${clientes}]]*/ []; 
          const todosVeiculos = /*[[${veiculos}]]*/ []; 

          // Elementos do Formulário Principal
          const formContainer = document.getElementById('agendamento-form-container');
          const formAgendamento = document.getElementById('agendamento-form');
          const btnNovoAgendamento = document.getElementById('btn-novo-agendamento');
          const btnCancelar = document.getElementById('btn-cancelar-novo-agendamento');
          
          // Campos de Cliente e Veículo
          const inputNome = document.getElementById('nome-cliente');
          const inputId = document.getElementById('idCliente');
          const datalistCli = document.getElementById('lista-clientes');
          const inputVeiculo = document.getElementById('veiculo');
          const inputIdVeiculo = document.getElementById('idVeiculo');
          const datalistVeic = document.getElementById('lista-veiculos');
          const btnAddVeiculo = document.getElementById('add-veiculo');

          // Elementos Mobile/QR Code
          const btnQrCode = document.getElementById('btn-abrir-qrcode');
          const inputToken = document.getElementById('tokenMobile');
          const avisoMobile = document.getElementById('aviso-token-mobile');
          const btnCancelarMobile = document.getElementById('btn-cancelar-mobile');
          const qrcodeContainer = document.getElementById('qrcode-container');
          const modalQrCodeEl = document.getElementById('modalQrCode');
          const modalQrCode = modalQrCodeEl ? new bootstrap.Modal(modalQrCodeEl) : null;

          // ============================
          // LÓGICA DE CLIENTE E VEÍCULO 
          // ============================

          // Função para Habilitar/Desabilitar campos de veículo
          function toggleCamposVeiculo(habilitar) {
              if (inputVeiculo && btnAddVeiculo) {
                  inputVeiculo.disabled = !habilitar;
                  btnAddVeiculo.disabled = !habilitar;
                  
                  if (habilitar) {
                      inputVeiculo.placeholder = "Modelo/Placa do veículo";
                  } else {
                      inputVeiculo.value = "";
                      if(inputIdVeiculo) inputIdVeiculo.value = "";
                      inputVeiculo.placeholder = "Selecione o cliente primeiro...";
                      inputVeiculo.classList.remove('is-valid');
                      if(datalistVeic) datalistVeic.innerHTML = "";
                  }
              }
          }

          // Estado Inicial: Bloqueia se não tiver cliente selecionado
          if (!inputId || !inputId.value) {
              toggleCamposVeiculo(false);
          }

          // Preenche Datalist de Clientes
          if (todosClientes && datalistCli) {
              todosClientes.forEach(c => {
                  const opt = document.createElement('option');
                  opt.value = c.nomeCliente;
                  datalistCli.appendChild(opt);
              });
          }

          // Evento: Digitar Cliente
          if (inputNome) {
              inputNome.addEventListener('input', function() {
                  const valor = this.value.trim();
                  
                  if (valor === "") {
                      inputId.value = "";
                      this.classList.remove('is-valid');
                      toggleCamposVeiculo(false);
                      return;
                  }

                  // Busca cliente
                  const cliente = todosClientes.find(c => c.nomeCliente === valor);

                  if (cliente) {
                      inputId.value = cliente.idCliente;
                      this.classList.add('is-valid');
                      this.classList.remove('is-invalid');
                      
                      toggleCamposVeiculo(true);
                      filtrarVeiculos(cliente.idCliente);
                  } else {
                      inputId.value = "";
                      this.classList.remove('is-valid');
                      toggleCamposVeiculo(false);
                  }
              });
          }

          // Função: Filtrar Veículos por Cliente
          function filtrarVeiculos(idCliente) {
              if(!todosVeiculos || !datalistVeic) return;
              
              datalistVeic.innerHTML = "";
              inputVeiculo.value = "";
              if(inputIdVeiculo) inputIdVeiculo.value = "";
              
              const filtrados = todosVeiculos.filter(v => v.cliente && v.cliente.idCliente === idCliente);
              
              filtrados.forEach(v => {
                  const opt = document.createElement('option');
                  opt.value = v.modelo + " - " + v.placa;
                  datalistVeic.appendChild(opt);
              });
              
              // Regra: Se só tem 1, seleciona automático
              if (filtrados.length === 1) {
                  const v = filtrados[0];
                  inputVeiculo.value = v.modelo + " - " + v.placa;
                  if(inputIdVeiculo) inputIdVeiculo.value = v.idVeiculo;
                  inputVeiculo.classList.add('is-valid');
              }
          }

          // Evento: Selecionar Veículo Manualmente (quando tem 2+)
          if (inputVeiculo) {
              inputVeiculo.addEventListener('input', function() {
                  const valor = this.value;
                  const idCli = parseInt(inputId.value);
                  const veiculo = todosVeiculos.find(v => 
                      (v.modelo + " - " + v.placa) === valor && 
                      (v.cliente && v.cliente.idCliente === idCli)
                  );
                  
                  if (veiculo) {
                      if(inputIdVeiculo) inputIdVeiculo.value = veiculo.idVeiculo;
                      this.classList.add('is-valid');
                  } else {
                      if(inputIdVeiculo) inputIdVeiculo.value = "";
                      this.classList.remove('is-valid');
                  }
              });
          }

          // =================================================
          // CONTROLE DO FORMULÁRIO (NOVO / CANCELAR / EDITAR)
          // =================================================

          if (btnNovoAgendamento) {
              btnNovoAgendamento.addEventListener('click', function () {
                  document.getElementById('idAgendamento').value = "";
                  document.getElementById('formTitulo').innerHTML = '<i class="fas fa-plus"></i> Novo Agendamento';
                  
                  if(inputNome) { inputNome.value = ""; inputNome.classList.remove('is-valid'); }
                  if(inputId) inputId.value = "";
                  
                  toggleCamposVeiculo(false);
                  
                  if(inputToken) inputToken.value = "";
                  if(avisoMobile) { avisoMobile.classList.remove('d-flex'); avisoMobile.style.display = 'none'; }
                  
                  document.getElementById('form-preview-imagens').innerHTML = "";
                  if(formAgendamento) formAgendamento.reset();

                  if(formContainer) {
                      formContainer.style.display = 'block';
                      formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  }
              });
          }

          if (btnCancelar) {
              btnCancelar.addEventListener('click', function () {
                  if(formContainer) formContainer.style.display = 'none';
                  if(formAgendamento) formAgendamento.reset();
                  document.getElementById('lista-agendamentos-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
              });
          }

          // Editar
          document.querySelectorAll('.btn-edit').forEach(btn => {
              btn.addEventListener('click', function () {
                  const row = this.closest('tr');
                  const id = this.dataset.id;
				  
				  const veiculoId = this.getAttribute('data-veiculo-id');
				  const veiculoNome = this.getAttribute('data-veiculo-nome');
                  
                  document.getElementById('formTitulo').innerHTML = '<i class="fas fa-edit"></i> Editar Agendamento';
                  document.getElementById('idAgendamento').value = id;
                  
                  // Preencher campos
                  if(inputNome) inputNome.value = row.querySelector('.ag-cliente span').textContent.trim();
                  const nomeNaTabela = inputNome.value;
                  const cliObj = todosClientes.find(c => c.nomeCliente === nomeNaTabela);
                  if(cliObj) {
                      inputId.value = cliObj.idCliente;
                      toggleCamposVeiculo(true); // Destrava veículo na edição
                  }
				  
				  if (veiculoId && veiculoNome) {
                      document.getElementById('veiculo').value = veiculoNome;
                      document.getElementById('idVeiculo').value = veiculoId;
                  } else {
                      document.getElementById('veiculo').value = "";
                      document.getElementById('idVeiculo').value = "";
                  }

                  // ... Resto dos campos (Serviço, Status, Data, Obs) ...
                  document.getElementById('nome-servico').value = row.querySelector('.ag-servico').dataset.servicoId;
                  
                  // Status e Data Conclusão
                  const statusTxt = row.querySelector('.ag-status span').textContent.trim();
                  const statusSel = document.getElementById('status');
                  // Tenta achar o option pelo texto
                  for(let i=0; i<statusSel.options.length; i++) {
                      if(statusSel.options[i].text.replace(/\s/g, '') === statusTxt.replace(/\s/g, '')) {
                          statusSel.selectedIndex = i; break;
                      }
                  }
                  checkStatus(); // Atualiza visibilidade da data conclusão

                  const prev = row.querySelector('.ag-previsao');
                  if(prev) document.getElementById('data-previsao').value = prev.dataset.date;
                  const conc = row.querySelector('.ag-conclusao');
                  if(conc) document.getElementById('data-conclusao').value = conc.dataset.date || '';
                  
                  document.getElementById('observacao').value = row.querySelector('.ag-observacao').textContent.trim();

                  formContainer.style.display = 'block';
                  formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
              });
          });

          // ============================================================
          // LÓGICA MOBILE / UPLOAD
          // ============================================================

          function uuidv4() {
              return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                  (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
              );
          }

          if(btnQrCode) {
              btnQrCode.addEventListener('click', function() {
                  if(!inputToken.value) {
                      inputToken.value = uuidv4();
                      if(avisoMobile) {
                          avisoMobile.style.display = 'flex';
                          avisoMobile.classList.add('d-flex');
                      }
                  }
                  const url = `http://192.168.23.107:8080/mobile/upload-fotos/${inputToken.value}`;
                  
                  if(qrcodeContainer) {
                      qrcodeContainer.innerHTML = "";
                      new QRCode(qrcodeContainer, { text: url, width: 200, height: 200 });
                  }
                  if(modalQrCode) modalQrCode.show();
              });
          }

          if(btnCancelarMobile) {
              btnCancelarMobile.addEventListener('click', function() {
                  const tok = inputToken.value;
                  if(tok) fetch(`/mobile/cancelar/${tok}`, { method: 'DELETE' });
                  
                  inputToken.value = "";
                  avisoMobile.classList.remove('d-flex');
                  avisoMobile.style.display = 'none';
              });
          }

          // Preview de Imagens Desktop
          const inpImg = document.getElementById('agendamento-imagens');
          const prevDiv = document.getElementById('form-preview-imagens');
          if(inpImg && prevDiv) {
              inpImg.addEventListener('change', function() {
                  prevDiv.innerHTML = "";
                  Array.from(this.files).forEach(f => {
                      if(f.type.startsWith('image/')) {
                          const r = new FileReader();
                          r.onload = e => {
                              const i = document.createElement('img');
                              i.src = e.target.result;
                              i.style.width = '80px'; i.style.height = '80px';
                              i.className = 'border rounded p-1 object-fit-cover me-2';
                              prevDiv.appendChild(i);
                          };
                          r.readAsDataURL(f);
                      }
                  });
              });
          }

          // ============================================================
          // VISUALIZAR (COM FOTOS DO BANCO)
          // ============================================================
          
          const modalVisEl = document.getElementById('visualizarAgendamentoModal');
          if (modalVisEl) {
              const modalVis = new bootstrap.Modal(modalVisEl);

              document.querySelectorAll('.btn-view').forEach(btn => {
                  btn.addEventListener('click', function () {
                      const row = this.closest('tr');
                      const idAgendamento = this.dataset.id;
					  const galeriaVis = document.getElementById('galeria-visualizacao')

                      // Preenche textos
                      document.getElementById('modal-cliente-agendamento').textContent = row.querySelector('.ag-cliente').textContent.trim();
                      document.getElementById('modal-servico-agendamento').textContent = row.querySelector('.ag-servico').textContent.trim();
                      document.getElementById('modal-previsao-agendamento').textContent = row.querySelector('.ag-previsao').textContent.trim();
                      document.getElementById('modal-observacao').textContent = row.querySelector('.ag-observacao').textContent.trim();
                      document.getElementById('modal-status').textContent = row.querySelector('.ag-status span').textContent.trim();
                      document.getElementById('modal-conclusao').textContent = row.querySelector('.ag-conclusao').textContent.trim();

                      // Busca Fotos
                      galeriaVis.innerHTML = '<p class="text-muted small w-100 text-center">Carregando imagens...</p>';
                      
                      fetch(`/fotos-api/listar/${idAgendamento}`)
                      .then(r => {
                          if(r.status === 204) return [];
                          return r.json();
                      })
                      .then(fotos => {
                          galeriaVis.innerHTML = "";
                          if(!fotos || fotos.length === 0) {
                              galeriaVis.innerHTML = '<p class="text-muted small w-100 text-center">Sem fotos anexadas.</p>';
                              return;
                          }
                          fotos.forEach(f => {
                              const div = document.createElement('div');
                              div.className = 'border rounded p-1';
                              const img = document.createElement('img');
                              // Endpoint de Visualização
                              img.src = `/fotos-api/imagem/${f.id}`;
                              img.style.width = '100px'; img.style.height = '100px';
                              img.style.objectFit = 'cover'; img.style.cursor = 'pointer';
                              img.onclick = () => window.open(img.src, '_blank');
                              div.appendChild(img);
                              galeriaVis.appendChild(div);
                          });
                      })
                      .catch(e => {
                          console.error(e);
                          galeriaVis.innerHTML = '<p class="text-danger small">Erro ao carregar.</p>';
                      });

                      modalVis.show();
                  });
              });
          }

          // ============================================================
          // UTILITÁRIOS (Status, Filtros, Delete, Modais Rápidos)
          // ============================================================

          // Status -> Data Conclusão
          const statusSel = document.getElementById('status');
          const divConc = document.getElementById('data_conclusao_container');
          const inpConc = document.getElementById('data-conclusao');
          function checkStatus() {
              if(statusSel && statusSel.value === 'Concluido') {
                  divConc.style.display = 'block';
                  inpConc.required = true;
                  if(!inpConc.value) inpConc.value = new Date().toISOString().split('T')[0];
              } else {
                  if(divConc) divConc.style.display = 'none';
                  if(inpConc) { inpConc.required = false; inpConc.value = ""; }
              }
          }
          if(statusSel) statusSel.addEventListener('change', checkStatus);
          checkStatus();

          // Excluir
          document.querySelectorAll('.btn-delete').forEach(btn => {
              btn.addEventListener('click', function (e) {
                  e.preventDefault();
                  const id = this.dataset.id;
                  Swal.fire({
                      title: 'Excluir?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Sim'
                  }).then(r => {
                      if(r.isConfirmed) {
                          document.getElementById('deleteId').value = id;
                          document.getElementById('deleteForm').submit();
                      }
                  });
              });
          });

          // Concluir Rápido
          document.querySelectorAll('.btn-concluir').forEach(btn => {
              btn.addEventListener('click', function () {
                  const id = this.dataset.id;
                  Swal.fire({ title: 'Concluir Serviço?', icon: 'question', showCancelButton: true }).then(r => {
                      if(r.isConfirmed) {
                          fetch(`/agendamento-api/concluir/${id}`, { method: 'POST' })
                          .then(res => res.ok ? res.json() : Promise.reject())
                          .then(() => Swal.fire('Sucesso', '', 'success').then(() => location.reload()))
                          .catch(() => Swal.fire('Erro', '', 'error'));
                      }
                  });
              });
          });

          // Filtros da Tabela
          const busca = document.getElementById('busca');
          const filtroSt = document.getElementById('filtro_status');
          function filtrar() {
              const t = busca.value.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              const s = filtroSt.value.toLowerCase();
              document.querySelectorAll('tbody tr').forEach(row => {
                  const txt = row.textContent.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                  const badge = row.querySelector('.status-badge');
                  const stText = badge ? badge.textContent.toLowerCase().replace(/\s/g, '') : '';
                  
                  const okBusca = !t || txt.includes(t);
                  const okStatus = !s || stText.includes(s.replace(/\s/g, ''));
                  row.style.display = (okBusca && okStatus) ? '' : 'none';
              });
          }
          if(busca) busca.addEventListener('input', filtrar);
          if(filtroSt) filtroSt.addEventListener('change', filtrar);

          // Menu
          const ham = document.getElementById('hamburger-menu');
          const nav = document.getElementById('nav-menu');
          if(ham && nav) ham.addEventListener('click', () => { nav.classList.toggle('active'); ham.classList.toggle('active'); });

          // Cadastro Rápido Cliente (Modal)
          const btnSalvarCli = document.getElementById('btn-salvar-novo-cliente');
          if(btnSalvarCli) {
              btnSalvarCli.addEventListener('click', function() {
                  const n = document.getElementById('novo-cliente-nome').value;
                  const t = document.getElementById('novo-cliente-telefone').value;
                  const e = document.getElementById('novo-cliente-email').value;
                  if(!n) return Swal.fire('Erro', 'Nome obrigatório', 'error');

                  fetch('/cliente-api/salvar', {
                      method: 'POST', headers: {'Content-Type': 'application/json'},
                      body: JSON.stringify({nomeCliente: n, telefone: t, email: e})
                  }).then(r => r.ok ? r.json() : Promise.reject())
                  .then(cli => {
                      // Atualiza lista global e campos
                      todosClientes.push(cli);
                      inputNome.value = cli.nomeCliente;
                      inputId.value = cli.idCliente;
                      
                      // Adiciona na lista visual
                      const opt = document.createElement('option'); opt.value = cli.nomeCliente;
                      datalistCli.appendChild(opt);
                      
                      toggleCamposVeiculo(true);
                      
                      bootstrap.Modal.getInstance(document.getElementById('cadastrarClienteModal')).hide();
                      document.getElementById('form-novo-cliente').reset();
                      Swal.fire('Sucesso', 'Cliente cadastrado', 'success');
                  }).catch(() => Swal.fire('Erro', 'Falha ao salvar', 'error'));
              });
          }

          // Cadastro Rápido Veículo (Modal)
          const btnSalvarVeic = document.getElementById('btn-salvar-novo-veiculo');
          if(btnSalvarVeic) {
              btnSalvarVeic.addEventListener('click', function() {
                  const idCli = inputId.value;
                  const mod = document.getElementById('novo-veiculo-modelo').value;
                  const pla = document.getElementById('novo-veiculo-placa').value;
                  const mar = document.getElementById('novo-veiculo-marca').value;
                  
                  if(!mod || !pla) return Swal.fire('Erro', 'Preencha modelo e placa', 'error');

                  fetch('/veiculo-api/salvar', {
                      method: 'POST', headers: {'Content-Type': 'application/json'},
                      body: JSON.stringify({
                          cliente: {idCliente: idCli}, modelo: mod, placa: pla, marca: mar
                      })
                  }).then(r => r.ok ? r.json() : Promise.reject())
                  .then(v => {
                      todosVeiculos.push(v);
                      inputVeiculo.value = v.modelo + " - " + v.placa;
                      if(inputIdVeiculo) inputIdVeiculo.value = v.idVeiculo;
                      
                      bootstrap.Modal.getInstance(document.getElementById('cadastrarVeiculoModal')).hide();
                      document.getElementById('form-novo-veiculo').reset();
                      Swal.fire('Sucesso', 'Veículo salvo', 'success');
                  }).catch(() => Swal.fire('Erro', 'Falha ao salvar', 'error'));
              });
          }
      });
    </script>
</body>
</html>