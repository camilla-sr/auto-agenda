<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produtos - Centro Automotivo JJ</title>
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css"> <!-- Adicionado Bootstrap CSS -->
  <link rel="stylesheet" href="/css/modal-fix.css">
  <link rel="stylesheet" href="/css/produtos.css">
  <link rel="stylesheet" href="/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="/css/main-styles.css"> <!-- Adicionado main-styles -->
  <link rel="stylesheet" href="/css/custom.css"> <!-- NOSSA MUDANÇA -->
  <link rel="stylesheet" href="/css/style1.css">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/js/jquery-3.7.1.min.js"></script>
  <script src="/js/jquery.mask.min.js"></script>
  <script src="/js/sweetalert2.all.min.js"></script>
  <script src="/js/validacao.js"></script>
  <script src="/js/mascaras.js"></script>
</head>

<body>
  <div th:replace="~{barra :: barra}"></div>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h2><i class="fas fa-box-open"></i> Gerenciamento de Produtos</h2>
        <p>Controle seu estoque e cadastre novos itens</p>
      </div>

      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-boxes"></i>
          </div>
          <div class="stat-info">
            <h3 th:text="${totalProdutos}"></h3>
            <p>Produtos cadastrados</p>
          </div>
        </div>

        <div class="stat-card warning">
          <div class="stat-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="stat-info">
            <h3 th:text="${estoqueBaixo}"></h3>
            <p>Estoque baixo</p>
          </div>
        </div>

        <div class="stat-card danger">
          <div class="stat-icon">
            <i class="fas fa-times-circle"></i>
          </div>
          <div class="stat-info">
            <h3 th:text="${estoqueZerado}"></h3>
            <p>Itens esgotados</p>
          </div>
        </div>

        <div class="stat-card success">
          <div class="stat-icon">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="stat-info">
            <h3 th:text="'R$ ' + ${precoEstoque}"></h3>
            <p>Valor total em estoque</p>
          </div>
        </div>
      </div>

      <div class="form-container" id="formNovoProdutoContainer" style="display: none;">
        <h3 id="formTitulo"><i class="fas fa-plus"></i> Adicionar Novo Produto</h3>
        <form id="formNovoProduto" action="/produto-api/salvar" method="post">
          <div class="form-row">
            <input type="hidden" name="idProduto" id="idProduto" readonly>
            <div class="form-group">
              <label for="nome_produto" class="required">Nome do Produto</label>
              <div class="input-wrapper">
                <i class="fas fa-tag input-icon"></i>
                <input type="text" id="nome-produto" name="nomeProduto" placeholder="Ex: Óleo Motor 10W40" required>
              </div>
            </div>
            <div class="form-group">
              <label for="codigo_produto">Código</label>
              <div class="input-wrapper">
                <i class="fas fa-barcode input-icon"></i>
                <input type="text" id="codigo-produto" name="codigoProduto" placeholder="Ex: ABC123">
              </div>
            </div>
            <div class="form-group">
              <label for="categoria" class="required">Categoria</label>
              <div class="input-wrapper">
                <i class="fas fa-layer-group input-icon"></i>
                <select id="categoria" name="categoria" required>
                  <option value="" selected disabled>Selecione</option>
                  <option value="Oleo">Óleo</option>
                  <option value="Filtro">Filtro</option>
                  <option value="Pneu">Pneu</option>
                  <option value="Bateria">Bateria</option>
                  <option value="Outro">Outro</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="preco_compra" class="required">Preço de Compra (R$)</label>
              <div class="input-wrapper">
                <i class="fas fa-dollar-sign input-icon"></i>
                <input class="valores" type="text" id="preco-custo" name="precoCusto" placeholder="0,00"
                  inputmode="numeric" required>
              </div>
            </div>
            <div class="form-group">
              <label for="preco_venda" class="required">Preço de Venda (R$)</label>
              <div class="input-wrapper">
                <i class="fas fa-hand-holding-usd input-icon"></i>
                <input class="valores" type="text" id="preco-venda" name="precoVenda" placeholder="0,00"
                  inputmode="numeric" required>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="fornecedor">Fornecedor</label>
              <div class="input-wrapper">
                <i class="fas fa-truck input-icon"></i>
                <input type="text" id="fornecedor" name="fornecedor" placeholder="Nome do fornecedor">
              </div>
            </div>
            <div class="form-group">
              <label for="descricao">Descrição</label>
              <div class="input-wrapper">
                <i class="fas fa-align-left input-icon"></i>
                <input type="text" id="descricao" name="descricao" placeholder="Opcional">
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="estoque_atual" class="required">Estoque Atual</label>
              <div class="input-wrapper">
                <i class="fas fa-boxes input-icon"></i>
                <input type="number" id="estoque-atual" name="estoqueAtual" min="0" placeholder="0" required>
              </div>
            </div>
            <div class="form-group">
              <label for="estoque_minimo" class="required">Estoque Mínimo</label>
              <div class="input-wrapper">
                <i class="fas fa-exclamation-circle input-icon"></i>
                <input type="number" id="estoque-minimo" name="estoqueMinimo" min="0" placeholder="0" required>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="reset" class="btn btn-secondary" id="btn-cancelar-novo-produto">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="submit" class="btn btn-primary" id="btn-salvar" disabled>
              <i class="fas fa-save"></i> Salvar
            </button>
          </div>
        </form>
      </div>


      <div class="table-container">
        <div class="table-header">
          <h3><i class="fas fa-list-ul"></i> Lista de Produtos</h3>
          <button class="btn btn-primary" id="btn-novo-produto" type="button"><i class="fas fa-plus-circle"></i>Novo
            Produto</button>
        </div>

        <div class="table-actions">
          <input type="text" name="busca" id="busca" placeholder="Digite para buscar...">
        </div>
        
        <!-- MUDANÇA AQUI: Tabela com `data-label` para responsividade -->
        <table class="appointments-table" id="productsTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Código</th>
              <th>Preço de Venda</th>
              <th>Estoque</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr th:if="${produtos == null or produtos.empty}">
              <td colspan="6" style="text-align: center;">Nenhum resultado encontrado</td>
            </tr>
            <tr th:each="p : ${produtos}">
              <td data-label="Nome" class="nome-produto" th:text="${p.nomeProduto}"></td>
              <td data-label="Código" class="codigo-produto" th:text="${p.codigoProduto}"></td>
              <td class="categoria" th:text="${p.categoria}" style="display:none;"></td>
              <td class="preco-custo valores" th:attr="data-valor=${p.precoCusto}"
                th:text="${'R$ '+ #numbers.formatDecimal(p.precoCusto, 1, 'POINT', 2, 'COMMA')}" style="display:none;">
              </td>
              <td data-label="Preço Venda" class="preco-venda valores" th:attr="data-valor=${p.precoVenda}"
                th:text="${'R$ ' + #numbers.formatDecimal(p.precoVenda, 1, 'POINT', 2, 'COMMA')}"></td>
              <td class="fornecedor" th:text="${p.fornecedor}" style="display:none;"></td>
              <td class="estoque-minimo" th:text="${p.estoqueMinimo}" style="display:none;"></td>
              <td data-label="Estoque" class="estoque-atual" th:text="${p.estoqueAtual}"></td>
              <td class="descricao" th:text="${p.descricao}" style="display:none;"></td>
              <td data-label="Status"><span class="status-badge status-ok">Em estoque</span></td>
              <td class="action-buttons">
                <button class="btn-icon btn-edit" th:attr="data-id=${p.idProduto}" title="Editar"><i
                    class="fas fa-edit"></i></button>
                <button class="btn-icon btn-delete" th:attr="data-id=${p.idProduto}" title="Excluir"><i
                    class="fas fa-trash"></i></button>
                <button class="btn-icon btn-view" title="Detalhes"><i class="fas fa-eye"></i></button>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="pagination">
          <button>Anterior</button>
          <span>Página 1 de X</span>
          <button>Próximo</button>
        </div>
      </div>
    </div>

    <!-- Modal de Visualização (sem alterações) -->
    <div class="bootstrap-iso">
      <div class="modal fade" id="visualizarProdutoModal" tabindex="-1" aria-labelledby="visualizarProdutoModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="visualizarProdutoModalLabel">
                <i class="fas fa-eye"></i> Detalhes do Produto
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-8">
                  <h4><strong id="modal-nome-produto"></strong></h4>
                  <p class="text-muted">Código: <span id="modal-codigo-produto"></span></p>
                </div>
                <div class="col-md-4 text-md-end">
                  <h5>Valor de Venda</h5>
                  <h4 class="text-success fw-bold" id="modal-preco-venda"></h4>
                </div>
              </div>
              <hr>
              <h6><i class="fas fa-align-left me-2"></i>Descrição</h6>
              <p id="modal-descricao" style="white-space: pre-wrap;"></p>
              <hr>
              <div class="row">
                <div class="col-sm-6">
                  <p><strong>Categoria:</strong> <span id="modal-categoria"></span></p>
                  <p><strong>Fornecedor:</strong> <span id="modal-fornecedor"></span></p>
                </div>
                <div class="col-sm-6">
                  <p><strong>Estoque Atual:</strong> <span id="modal-estoque-atual"></span> unidades</p>
                  <p><strong>Estoque Mínimo:</strong> <span id="modal-estoque-minimo"></span> unidades</p>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times"></i> Fechar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo">
          <i class="fas fa-car-alt"></i>
          <span class="logo-highlight">Centro Automotivo</span> JJ
        </div>
        <p class="footer-copyright">&copy; 2025 Centro Automotivo JJ. Todos os direitos reservados.</p>
      </div>
    </div>
  </footer>

  <!-- SCRIPT ORIGINAL DA PÁGINA (sem alterações) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('formNovoProduto');
      const formTitulo = document.getElementById('formTitulo');
      const botaoSalvar = form.querySelector('button[type="submit"]');

      const camposObrigatorios = [
        'nome-produto',
        'preco-custo',
        'preco-venda',
        'categoria',
        'estoque-atual',
        'estoque-minimo'
      ];

      function verificarCampos() {
        let valido = true;
        camposObrigatorios.forEach(id => {
          const campo = document.getElementById(id);
          if (!campo || !campo.value || campo.value === '') {
            valido = false;
          }
        });
        botaoSalvar.disabled = !valido;
      }

      camposObrigatorios.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
          campo.addEventListener('input', verificarCampos);
        }
      });

      const btnNovoProduto = document.getElementById('btn-novo-produto');
      const formProdutoContainer = document.getElementById('formNovoProdutoContainer');
      const btnCancelarNovoProduto = document.getElementById('btn-cancelar-novo-produto');

      btnNovoProduto.addEventListener('click', () => {
        form.querySelector('#idProduto').value = "";
        formTitulo.innerHTML = '<i class="fas fa-plus"></i> Adicionar Novo Produto';
        formProdutoContainer.style.display = 'block';
        form.scrollIntoView({ behavior: 'smooth' });
      });

      btnCancelarNovoProduto.addEventListener('click', () => {
        form.reset();
        formProdutoContainer.style.display = 'none';
        verificarCampos();
      });

      $('#formNovoProduto').on('submit', function () {
        $(this).find('.valores').each(function () {
          const valorLimpo = $(this).cleanVal();
          let valorParaEnviar = (parseFloat(valorLimpo) / 100).toFixed(2);
          if (isNaN(valorParaEnviar)) { valorParaEnviar = ''; }
          $(this).val(valorParaEnviar);
        });
        return true;
      });

      verificarCampos();

      const editButtons = document.querySelectorAll('.btn-edit');
      editButtons.forEach(function (button) {
        button.addEventListener('click', function () {
          formTitulo.innerHTML = '<i class="fas fa-edit"></i> Editar Produto';
          if (formProdutoContainer.style.display === 'none' || formProdutoContainer.style.display === '') {
            formProdutoContainer.style.display = 'block';
            formProdutoContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          const row = button.closest('tr');
          const id = button.dataset.id;
          const nome = row.querySelector('.nome-produto').textContent.trim();
          const codigo = row.querySelector('.codigo-produto').textContent.trim();
          const categoria = row.querySelector('.categoria').textContent.trim();
          const custo = row.querySelector('.preco-custo').dataset.valor;
          const venda = row.querySelector('.preco-venda').dataset.valor;
          const fornecedor = row.querySelector('.fornecedor').textContent.trim();
          const estoqueA = row.querySelector('.estoque-atual').textContent.trim();
          const estoqueM = row.querySelector('.estoque-minimo').textContent.trim();
          const descricao = row.querySelector('.descricao').textContent.trim();

          document.getElementById('idProduto').value = id;
          document.getElementById('codigo-produto').value = codigo;
          document.getElementById('nome-produto').value = nome;
          document.getElementById('categoria').value = categoria;
          document.getElementById('preco-custo').value = custo;
          document.getElementById('preco-venda').value = venda;
          document.getElementById('fornecedor').value = fornecedor;
          document.getElementById('estoque-atual').value = estoqueA;
          document.getElementById('estoque-minimo').value = estoqueM;
          document.getElementById('descricao').value = descricao;

          verificarCampos();
        });
      });

      const deleteButtons = document.querySelectorAll('.btn-delete');
      deleteButtons.forEach(function (button) {
        button.addEventListener('click', function (e) {
          e.preventDefault();
          const id = button.dataset.id;
          Swal.fire({
            title: 'Você tem certeza?',
            text: "Esta ação não poderá ser desfeita!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sim, excluir!',
            cancelButtonText: 'Cancelar'
          }).then((result) => {
            if (result.isConfirmed) {
              fetch('/produto-api/apagar', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'idProduto=' + id
              }).then(response => {
                if (response.ok) {
                  Swal.fire('Excluído!', 'O produto foi excluído com sucesso.', 'success').then(() => window.location.reload());
                } else {
                  Swal.fire('Erro!', 'Não foi possível excluir o produto.', 'error');
                }
              }).catch(error => {
                console.error('Erro ao excluir o produto:', error);
                Swal.fire('Erro!', 'Ocorreu um erro de rede.', 'error');
              });
            }
          });
        });
      });

      const busca = document.getElementById('busca');
      const tabela = document.getElementById('productsTable');
      const linhas = tabela.querySelectorAll('tbody tr');
      const noResultMessage = document.querySelector('tbody tr td[colspan="6"]');

      busca.addEventListener('input', function () {
        const termoBusca = busca.value.toLowerCase();
        let found = false;
        linhas.forEach(function (linha) {
            if (linha.querySelector('td[colspan="6"]')) return;
            
            const textoLinha = linha.textContent.toLowerCase();
            if (textoLinha.includes(termoBusca)) {
                linha.style.display = '';
                found = true;
            } else {
                linha.style.display = 'none';
            }
        });

        if (noResultMessage) {
          noResultMessage.style.display = found ? 'none' : '';
        }
      });

      function atualizarStatusEstoque() {
        document.querySelectorAll('#productsTable tbody tr').forEach(function (row) {
            if (row.querySelector('td[colspan="6"]')) return;
            const badge = row.querySelector('.status-badge');
            const atualEl = row.querySelector('.estoque-atual');
            const minEl = row.querySelector('.estoque-minimo');
            if (!badge || !atualEl || !minEl) return;

            const toNumber = s => parseFloat((s || '').toString().trim()) || 0;
            const atual = toNumber(atualEl.textContent);
            const minimo = toNumber(minEl.textContent);

            badge.classList.remove('status-ok', 'bg-success', 'bg-warning', 'bg-danger', 'text-dark');

            if (atual <= 0) {
                badge.textContent = 'Esgotado';
                badge.classList.add('bg-danger');
            } else if (atual <= minimo) {
                badge.textContent = 'Estoque Baixo';
                badge.classList.add('bg-warning', 'text-dark');
            } else {
                badge.textContent = 'Em Estoque';
                badge.classList.add('bg-success');
            }
        });
      }
      atualizarStatusEstoque();

      const viewButtons = document.querySelectorAll('.btn-view');
      const visualizarModal = new bootstrap.Modal(document.getElementById('visualizarProdutoModal'));
      viewButtons.forEach(function (button) {
        button.addEventListener('click', function () {
          const row = button.closest('tr');
          document.getElementById('modal-nome-produto').textContent = row.querySelector('.nome-produto').textContent.trim();
          document.getElementById('modal-codigo-produto').textContent = row.querySelector('.codigo-produto').textContent.trim() || 'N/A';
          document.getElementById('modal-categoria').textContent = row.querySelector('.categoria').textContent.trim() || 'N/A';
          document.getElementById('modal-preco-venda').textContent = row.querySelector('.preco-venda').textContent.trim();
          document.getElementById('modal-fornecedor').textContent = row.querySelector('.fornecedor').textContent.trim() || 'Não informado';
          document.getElementById('modal-estoque-minimo').textContent = row.querySelector('.estoque-minimo').textContent.trim();
          document.getElementById('modal-estoque-atual').textContent = row.querySelector('.estoque-atual').textContent.trim();
          document.getElementById('modal-descricao').textContent = row.querySelector('.descricao').textContent.trim() || 'Nenhuma descrição fornecida.';
          visualizarModal.show();
        });
      });
    });
  </script>
</body>

</html>

